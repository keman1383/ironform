<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="IRONFORM"/>
  <meta name="theme-color" content="#1c1208"/>
  <title>IRONFORM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    :root {
      --bg:        #1c1208;
      --bg2:       #241a0a;
      --surface:   #2e2010;
      --surface2:  #3a2c14;
      --border:    #5a3e20;
      --border2:   #7a5530;
      --gold:      #c8922a;
      --gold2:     #e8b84b;
      --cream:     #f0e6cc;
      --cream2:    #d4c4a0;
      --muted:     #8a7055;
      --brick:     #c44b2b;
      --brick2:    #e06040;
      --green:     #4a7c59;
      --green2:    #6aa87a;
      --blue:      #4a6c8c;
      --blue2:     #6a90b8;
    }
    body {
      background: var(--bg);
      color: var(--cream);
      font-family: 'DM Sans', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    input, select, button, textarea { font-family: inherit; }
    select option { background: var(--surface2); color: var(--cream); }
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    * { -webkit-tap-highlight-color: transparent; }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 1000;
      opacity: 0.5;
    }
    .stamp {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .display-font { font-family: 'Playfair Display', serif; }
    .mono { font-family: 'DM Mono', monospace; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ‚îÄ‚îÄ VERSION INFO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const APP_VERSION = "2.0.0";
    const RELEASE_HISTORY = [
      {
        version: "2.0.0",
        date: "2026-02-28",
        features: [
          "Fixed keyboard dismissal bug on iPhone when adding exercises",
          "All exercises now removable from workout preview",
          "Weight adjustable in 0.25 lb increments during workout",
          "Version number on home screen with release history",
          "Exercise notes visible by clicking exercises in history log",
          "Per-rep weight and rep count tracking per set",
          "History exercises now editable",
          "Goals chart data points clickable ‚Äî shows date and weight",
          "Add exercise screen now centered vertically",
          "Past workout import modal requires X button to close (no accidental dismiss)",
          "History workouts now collapsible dropdowns",
          "Press Machine recategorized to Chest",
          "Import screen auto-scrolls when exercise added",
          "Drop sets and pyramid options for rep schemes",
          "Monthly workout calendar added to history screen",
        ],
      },
      {
        version: "1.0.0",
        date: "2026-01-01",
        features: [
          "Initial release",
          "Push / Pull / Legs templates",
          "Custom workout builder",
          "Lift goals with projection chart",
          "Workout history log",
          "Past workout import",
          "Firebase sync",
        ],
      },
    ];

    // ‚îÄ‚îÄ FIREBASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const FIREBASE_CONFIG = {
      apiKey:            "AIzaSyCQDJhJFUCuTQrymlmOx3Sgv54UUrMPekY",
      authDomain:        "trainerdata-c5e64.firebaseapp.com",
      projectId:         "trainerdata-c5e64",
      storageBucket:     "trainerdata-c5e64.firebasestorage.app",
      messagingSenderId: "71847069277",
      appId:             "1:71847069277:web:2dde9bfd125c5d6c466fb4",
    };

    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const gProvider = new firebase.auth.GoogleAuthProvider();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    const fbGetProfile    = async (uid) => { const d=await db.collection("users").doc(uid).get(); return d.exists?d.data():null; };
    const fbSetProfile    = async (uid,data) => db.collection("users").doc(uid).set(data,{merge:true});
    const fbGetWorkouts   = async (uid) => { const s=await db.collection("users").doc(uid).collection("workouts").orderBy("date").get(); return s.docs.map(d=>({...d.data(),_id:d.id})); };
    const fbAddWorkout    = async (uid,w) => { const r=await db.collection("users").doc(uid).collection("workouts").add(w); return r.id; };
    const fbUpdateWorkout = async (uid,id,w) => db.collection("users").doc(uid).collection("workouts").doc(id).set(w,{merge:true});
    const fbGetCustomExs  = async (uid) => { const s=await db.collection("users").doc(uid).collection("customExercises").get(); return s.docs.map(d=>({...d.data(),_fid:d.id})); };
    const fbAddCustomEx   = async (uid,ex) => { const r=await db.collection("users").doc(uid).collection("customExercises").add(ex); return r.id; };
    const fbGetLiftGoals  = async (uid) => { const s=await db.collection("users").doc(uid).collection("liftGoals").get(); return s.docs.map(d=>({...d.data(),_id:d.id})); };
    const fbAddLiftGoal   = async (uid,g) => { const r=await db.collection("users").doc(uid).collection("liftGoals").add(g); return r.id; };
    const fbDelLiftGoal   = async (uid,id) => db.collection("users").doc(uid).collection("liftGoals").doc(id).delete();

    // ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const BUILTIN_EXERCISES = [
      {id:"bench",            name:"Bench Press",                      category:"Chest",     unit:"lbs", defaultWeight:115,    increment:5},
      {id:"decline_press",    name:"Decline Press",                    category:"Chest",     unit:"lbs", defaultWeight:65,     increment:5},
      {id:"incline_db_press", name:"Incline Dumbbell Press",           category:"Chest",     unit:"lbs", defaultWeight:30,     increment:2.5},
      {id:"chest_fly",        name:"Chest Fly Machine",                category:"Chest",     unit:"lbs", defaultWeight:55,     increment:5},
      {id:"cable_fly",        name:"Cable Fly",                        category:"Chest",     unit:"lbs", defaultWeight:22.5,   increment:2.5},
      {id:"assisted_dip",     name:"Assisted Dip",                     category:"Chest",     unit:"lbs", defaultWeight:118.75, increment:2.5},
      // ‚òÖ Press Machine moved to Chest per request
      {id:"press_machine",    name:"Press Machine",                    category:"Chest",     unit:"lbs", defaultWeight:20,     increment:5},
      {id:"lat_pulldown",     name:"Lat Pull Down",                    category:"Back",      unit:"lbs", defaultWeight:105,    increment:5},
      {id:"row",              name:"Row",                              category:"Back",      unit:"lbs", defaultWeight:85,     increment:5},
      {id:"seated_cable_row", name:"Seated Cable Row",                 category:"Back",      unit:"lbs", defaultWeight:85,     increment:5},
      {id:"single_arm_row",   name:"Single Arm Cable Row",             category:"Back",      unit:"lbs", defaultWeight:45,     increment:2.5},
      {id:"high_row",         name:"High Row Machine",                 category:"Back",      unit:"lbs", defaultWeight:60,     increment:5},
      {id:"rdl",              name:"Romanian Deadlifts",               category:"Back",      unit:"lbs", defaultWeight:95,     increment:5},
      {id:"face_pull",        name:"Face Pulls",                       category:"Back",      unit:"lbs", defaultWeight:22.5,   increment:2.5},
      {id:"squat",            name:"Squat",                            category:"Legs",      unit:"lbs", defaultWeight:115,    increment:5},
      {id:"leg_press",        name:"Leg Press",                        category:"Legs",      unit:"lbs", defaultWeight:220,    increment:10},
      {id:"leg_curl",         name:"Leg Curl",                         category:"Legs",      unit:"lbs", defaultWeight:105,    increment:5},
      {id:"calf_raise",       name:"Calf Raise",                       category:"Legs",      unit:"lbs", defaultWeight:50,     increment:5},
      {id:"hip_adduction",    name:"Hip Adduction Machine",            category:"Legs",      unit:"lbs", defaultWeight:130,    increment:5},
      {id:"glute_drive",      name:"Glute Drive",                      category:"Legs",      unit:"lbs", defaultWeight:95,     increment:5},
      {id:"oh_db_press",      name:"Overhead Dumbbell Shoulder Press", category:"Shoulders", unit:"lbs", defaultWeight:10,     increment:2.5},
      {id:"lateral_raise",    name:"Dumbbell Lateral Raises",          category:"Shoulders", unit:"lbs", defaultWeight:10,     increment:2.5},
      {id:"shrugs",           name:"Shoulder Shrugs",                  category:"Shoulders", unit:"lbs", defaultWeight:17.5,   increment:2.5},
      {id:"cable_curl",       name:"Cable Curl",                       category:"Arms",      unit:"lbs", defaultWeight:22.5,   increment:2.5},
      {id:"one_arm_curl",     name:"One Arm Cable Curl",               category:"Arms",      unit:"lbs", defaultWeight:32.5,   increment:2.5},
      {id:"hammer_curl",      name:"Hammer Curl",                      category:"Arms",      unit:"lbs", defaultWeight:12.5,   increment:2.5},
      {id:"rope_hammer_curl", name:"Rope Hammer Curl",                 category:"Arms",      unit:"lbs", defaultWeight:22.5,   increment:2.5},
      {id:"db_bicep_curl",    name:"Seated Dumbbell Bicep Curls",      category:"Arms",      unit:"lbs", defaultWeight:15,     increment:2.5},
      {id:"preacher_curl",    name:"Preacher Curl Machine",            category:"Arms",      unit:"lbs", defaultWeight:10,     increment:2.5},
      {id:"tricep_pushdown",  name:"Tricep Push Down",                 category:"Arms",      unit:"lbs", defaultWeight:32.5,   increment:2.5},
      {id:"tricep_rope",      name:"Tricep Rope Push Down",            category:"Arms",      unit:"lbs", defaultWeight:27.5,   increment:2.5},
      {id:"one_arm_tricep",   name:"One Arm Cable Tricep",             category:"Arms",      unit:"lbs", defaultWeight:12.5,   increment:2.5},
      {id:"cable_ab_twist",   name:"Cable Ab Twist",                   category:"Core",      unit:"lbs", defaultWeight:12.5,   increment:2.5},
      {id:"hanging_leg_lift", name:"Hanging Leg Lifts",                category:"Core",      unit:"reps",defaultWeight:0,      increment:1},
    ];

    const CATEGORIES = ["Chest","Back","Legs","Shoulders","Arms","Core","Cardio","Other"];

    const GOALS = {
      strength:    {label:"Strength",     increment:1.05,  description:"Heavy weight, low reps"},
      hypertrophy: {label:"Muscle Growth",increment:1.025, description:"Moderate weight, higher reps"},
      endurance:   {label:"Endurance",    increment:1.015, description:"Light weight, high reps"},
      maintain:    {label:"Maintain",     increment:1.0,   description:"Hold current level"},
    };
    const GOAL_SETS = {
      strength:    {sets:5,reps:5},
      hypertrophy: {sets:4,reps:10},
      endurance:   {sets:3,reps:15},
      maintain:    {sets:3,reps:8},
    };

    const WORKOUT_TEMPLATES = [
      {id:"push",label:"Push Day",emoji:"üí™",accent:"#4a6c8c",accentDim:"rgba(74,108,140,0.15)",accentBorder:"rgba(74,108,140,0.45)",
        exercises:["bench","incline_db_press","cable_fly","lateral_raise","oh_db_press","tricep_rope","assisted_dip"]},
      {id:"pull",label:"Pull Day",emoji:"üèãÔ∏è",accent:"#4a6c8c",accentDim:"rgba(74,108,140,0.15)",accentBorder:"rgba(74,108,140,0.45)",
        exercises:["lat_pulldown","seated_cable_row","single_arm_row","preacher_curl","rope_hammer_curl"]},
      {id:"legs",label:"Leg Day",emoji:"ü¶µ",accent:"#4a6c8c",accentDim:"rgba(74,108,140,0.15)",accentBorder:"rgba(74,108,140,0.45)",
        exercises:["squat","rdl","leg_press","calf_raise","glute_drive","hip_adduction","leg_curl"]},
    ];

    function safeProgressWeight(current, goal, weeksSince, unit) {
      if (goal==="maintain") return current;
      const factor=Math.pow(GOALS[goal].increment, weeksSince||1);
      const proposed=Math.round((current*factor)/2.5)*2.5;
      const maxInc=({lbs:10,reps:2}[unit]||5)*(weeksSince||1);
      return Math.min(proposed, current+maxInc);
    }

    function projectGoalDate(history, targetWeight) {
      if (history.length < 2) return null;
      const t0 = new Date(history[0].date).getTime();
      const xs = history.map(h=>(new Date(h.date).getTime()-t0)/86400000);
      const ys = history.map(h=>h.weight);
      const n  = xs.length;
      const sx = xs.reduce((a,x)=>a+x,0);
      const sy = ys.reduce((a,y)=>a+y,0);
      const sxy= xs.reduce((a,x,i)=>a+x*ys[i],0);
      const sxx= xs.reduce((a,x)=>a+x*x,0);
      const denom = n*sxx - sx*sx;
      if (Math.abs(denom)<0.001) return null;
      const slope = (n*sxy - sx*sy)/denom;
      if (slope<=0) return null;
      const intercept = (sy - slope*sx)/n;
      const daysNeeded = (targetWeight - intercept)/slope;
      const targetDate = new Date(t0 + daysNeeded*86400000);
      if (targetDate < new Date()) return "already achieved!";
      return targetDate;
    }

    // ‚îÄ‚îÄ SHARED COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Modal with explicit X close (no outside-click dismiss)
    function ModalStrict({children, onClose, title}) {
      return (
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.8)",zIndex:500,display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"}}>
          <div style={{background:"#2a1c0c",border:"1px solid var(--border2)",borderRadius:16,width:"100%",maxWidth:480,maxHeight:"90vh",overflowY:"auto",padding:24,paddingBottom:32,position:"relative"}}>
            <button onClick={onClose} style={{position:"absolute",top:16,right:16,background:"none",border:"none",color:"var(--muted)",cursor:"pointer",fontSize:22,lineHeight:1,zIndex:10}}>√ó</button>
            {children}
          </div>
        </div>
      );
    }

    // Original modal (outside click closes) ‚Äî kept for non-form modals
    function Modal({children, onClose}) {
      return (
        <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.8)",zIndex:500,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
          <div onClick={e=>e.stopPropagation()} style={{background:"#2a1c0c",border:"1px solid var(--border2)",borderRadius:"16px 16px 0 0",width:"100%",maxWidth:480,maxHeight:"90vh",overflowY:"auto",padding:24,paddingBottom:44}}>
            {children}
          </div>
        </div>
      );
    }

    function BackBtn({onClick, label="Home"}) {
      return (
        <button onClick={onClick} style={{background:"none",border:"none",color:"var(--muted)",cursor:"pointer",display:"flex",alignItems:"center",gap:6,fontFamily:"'DM Mono',monospace",fontSize:11,letterSpacing:2,padding:"0 0 18px 0",textTransform:"uppercase"}}>
          ‚Üê {label}
        </button>
      );
    }

    function Stepper({value, onChange, min=1, label}) {
      return (
        <div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:8}}>
          <span style={{fontFamily:"'DM Mono',monospace",fontSize:9,letterSpacing:3,color:"var(--muted)",textTransform:"uppercase"}}>{label}</span>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <button onClick={()=>onChange(Math.max(min,value-1))} style={{width:34,height:34,borderRadius:6,border:"1px solid var(--border2)",background:"var(--surface)",color:"var(--gold)",fontSize:18,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>‚àí</button>
            <span style={{fontFamily:"'DM Mono',monospace",fontSize:22,fontWeight:500,color:"var(--cream)",minWidth:32,textAlign:"center"}}>{value}</span>
            <button onClick={()=>onChange(value+1)} style={{width:34,height:34,borderRadius:6,border:"1px solid var(--border2)",background:"var(--surface)",color:"var(--gold)",fontSize:18,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>+</button>
          </div>
        </div>
      );
    }

    // ‚îÄ‚îÄ INTERACTIVE MINI CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function MiniChart({history, targetWeight, width=300, height=120}) {
      const [tooltip, setTooltip] = useState(null);
      if (history.length<1) return <div style={{color:"var(--muted)",fontSize:12,textAlign:"center",padding:20}}>No data yet</div>;
      const t0=new Date(history[0].date).getTime();
      const tNow=Date.now();
      const projDate=history.length>=2?projectGoalDate(history,targetWeight):null;
      const tEnd=projDate&&projDate instanceof Date?Math.max(projDate.getTime(),tNow+7*86400000):tNow+30*86400000;
      const allW=[...history.map(h=>h.weight),targetWeight];
      const minW=Math.min(...allW)*0.95, maxW=Math.max(...allW)*1.02;
      const tx=t=>(t-t0)/(tEnd-t0)*width;
      const ty=w=>height-(w-minW)/(maxW-minW)*height;
      const pts=history.map(h=>`${tx(new Date(h.date).getTime())},${ty(h.weight)}`).join(" ");
      const lastH=history[history.length-1];
      const projLine=projDate&&projDate instanceof Date?
        `M${tx(new Date(lastH.date).getTime())},${ty(lastH.weight)} L${tx(projDate.getTime())},${ty(targetWeight)}`:null;

      return (
        <div style={{position:"relative"}}>
          <svg viewBox={`0 0 ${width} ${height}`} style={{width:"100%",height:height,overflow:"visible"}}>
            <line x1="0" y1={ty(targetWeight)} x2={width} y2={ty(targetWeight)} stroke="var(--green2)" strokeWidth="1" strokeDasharray="4,3" opacity="0.6"/>
            <text x={width-2} y={ty(targetWeight)-4} textAnchor="end" fontSize="9" fill="var(--green2)" fontFamily="DM Mono,monospace">{targetWeight} lbs</text>
            {history.length>1&&<polyline points={pts} fill="none" stroke="var(--gold)" strokeWidth="2.5" strokeLinejoin="round" strokeLinecap="round"/>}
            {projLine&&<path d={projLine} fill="none" stroke="var(--gold2)" strokeWidth="1.5" strokeDasharray="5,4" opacity="0.7"/>}
            {/* Clickable data dots */}
            {history.map((h,i)=>{
              const cx=tx(new Date(h.date).getTime());
              const cy=ty(h.weight);
              return(
                <g key={i} style={{cursor:"pointer"}} onClick={()=>setTooltip(tooltip&&tooltip.i===i?null:{i,date:h.date,weight:h.weight,cx,cy})}>
                  <circle cx={cx} cy={cy} r="8" fill="transparent"/>
                  <circle cx={cx} cy={cy} r={tooltip&&tooltip.i===i?"5":"3.5"} fill={tooltip&&tooltip.i===i?"var(--gold2)":"var(--gold)"} stroke="var(--bg2)" strokeWidth="1.5"/>
                </g>
              );
            })}
            <line x1={tx(tNow)} y1="0" x2={tx(tNow)} y2={height} stroke="var(--cream2)" strokeWidth="0.5" opacity="0.3"/>
          </svg>
          {tooltip&&(
            <div style={{position:"absolute",top:Math.max(0,tooltip.cy-50),left:Math.min(width*0.7,tooltip.cx),background:"var(--surface2)",border:"1px solid var(--border2)",borderRadius:6,padding:"6px 10px",fontFamily:"'DM Mono',monospace",fontSize:10,color:"var(--cream)",zIndex:10,pointerEvents:"none",whiteSpace:"nowrap"}}>
              <div style={{color:"var(--gold)"}}>{tooltip.weight} lbs</div>
              <div style={{color:"var(--muted)"}}>{new Date(tooltip.date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}</div>
            </div>
          )}
        </div>
      );
    }

    // ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function App() {
      const [authUser,      setAuthUser]      = useState(undefined);
      const [screen,        setScreen]        = useState("home");
      const [profile,       setProfileS]      = useState(null);
      const [workouts,      setWorkouts]      = useState([]);
      const [customExs,     setCustomExs]     = useState([]);
      const [liftGoals,     setLiftGoals]     = useState([]);
      const [dataLoading,   setDataLoading]   = useState(false);

      // Workout state
      const [activeTmpl,    setActiveTmpl]    = useState(null);
      const [extraExIds,    setExtraExIds]    = useState([]);
      // removedExIds: built-in exercises removed from the current template preview
      const [removedExIds,  setRemovedExIds]  = useState([]);
      const [previewSets,   setPreviewSets]   = useState(4);
      const [previewReps,   setPreviewReps]   = useState(10);
      // rep scheme type: "standard" | "dropset" | "pyramid"
      const [repScheme,     setRepScheme]     = useState("standard");
      const [activeWorkout, setActiveWorkout] = useState(null);
      const [currentExIdx,  setCurrentExIdx]  = useState(0);
      const [completedSets, setCompletedSets] = useState({});
      // perSetData: {[exId_setIdx]: {weight, reps}}
      const [perSetData,    setPerSetData]    = useState({});
      const [noteFor,       setNoteFor]       = useState({});
      const [summaryData,   setSummaryData]   = useState(null);

      // Custom builder
      const [customExIds,   setCustomExIds]   = useState([]);
      const [customGoal,    setCustomGoal]    = useState("hypertrophy");

      // Modal & forms
      const [modal,         setModal]         = useState(null);
      const [newEx,         setNewEx]         = useState({name:"",category:"Chest",unit:"lbs",defaultWeight:45,increment:5});
      const [newLiftGoal,   setNewLiftGoal]   = useState({exId:"",targetWeight:""});
      const [pastDate,      setPastDate]      = useState("");
      const [pastRows,      setPastRows]      = useState([{exId:"",weight:"",reps:"",sets:""}]);
      const [signInErr,     setSignInErr]     = useState(null);
      const [signingIn,     setSigningIn]     = useState(false);
      const [toast,         setToast]         = useState(null);
      const toastTimer = useRef(null);
      const pastRowsEndRef = useRef(null);

      // History screen
      const [expandedWorkouts, setExpandedWorkouts] = useState({});
      const [expandedExNote,   setExpandedExNote]   = useState({});
      const [editingWorkout,   setEditingWorkout]   = useState(null); // workout being edited
      const [historyTab,       setHistoryTab]       = useState("log"); // "log" | "calendar"

      // Version modal
      const [showVersion,      setShowVersion]      = useState(false);

      const allExercises = [...BUILTIN_EXERCISES, ...customExs];

      // ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      useEffect(()=>{
        const unsub=auth.onAuthStateChanged(async user=>{
          setAuthUser(user||null);
          if(user) loadData(user.uid);
        });
        return()=>unsub();
      },[]);

      const loadData = async (uid) => {
        setDataLoading(true);
        try {
          const [prof,wkts,cexs,lgs]=await Promise.all([fbGetProfile(uid),fbGetWorkouts(uid),fbGetCustomExs(uid),fbGetLiftGoals(uid)]);
          if(prof) setProfileS(prof);
          setWorkouts(wkts); setCustomExs(cexs); setLiftGoals(lgs);
        } catch(e){console.error(e);}
        setDataLoading(false);
      };

      useEffect(()=>{
        if(authUser&&!dataLoading&&profile===null){
          const p={goal:"hypertrophy",exercises:[],created:new Date().toISOString(),uid:authUser.uid};
          saveProfile(p);
        }
      },[authUser,dataLoading,profile]);

      const handleSignIn = async () => {
        setSignInErr(null); setSigningIn(true);
        try{await auth.signInWithPopup(gProvider);}
        catch(e){
          setSigningIn(false);
          if(e.code!=="auth/popup-closed-by-user"&&e.code!=="auth/cancelled-popup-request")
            setSignInErr("Sign-in failed: "+(e.message||e.code));
        }
      };

      const handleSignOut = async () => { await auth.signOut(); setProfileS(null);setWorkouts([]);setCustomExs([]);setLiftGoals([]);setScreen("home"); };

      const showToast=(msg)=>{setToast(msg);clearTimeout(toastTimer.current);toastTimer.current=setTimeout(()=>setToast(null),3000);};

      const saveProfile = async(p)=>{setProfileS(p);if(authUser)await fbSetProfile(authUser.uid,p);};
      const addWorkoutRecord = async(w)=>{if(authUser){const id=await fbAddWorkout(authUser.uid,w);w={...w,_id:id};}setWorkouts(prev=>[...prev,w].sort((a,b)=>new Date(a.date)-new Date(b.date)));};
      const updateWorkoutRecord = async(w)=>{if(authUser&&w._id)await fbUpdateWorkout(authUser.uid,w._id,w);setWorkouts(prev=>prev.map(x=>x._id===w._id?w:x));};
      const doAddCustomEx = async(ex)=>{if(authUser){const fid=await fbAddCustomEx(authUser.uid,ex);ex={...ex,_fid:fid};}setCustomExs(prev=>[...prev,ex]);return ex;};
      const doAddLiftGoal = async(g)=>{if(authUser){const id=await fbAddLiftGoal(authUser.uid,g);g={...g,_id:id};}setLiftGoals(prev=>[...prev,g]);};
      const doDelLiftGoal = async(id)=>{if(authUser)await fbDelLiftGoal(authUser.uid,id);setLiftGoals(prev=>prev.filter(g=>g._id!==id));};

      // ‚îÄ‚îÄ WORKOUT LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const getLastForExercise=(exId)=>{
        for(let i=workouts.length-1;i>=0;i--){
          const ex=workouts[i].exercises?.find(e=>e.id===exId);
          if(ex) return{workout:workouts[i],exercise:ex};
        }
        return null;
      };

      const buildExerciseList=(exIdList,sets,reps)=>{
        const goal=profile?.goal||"hypertrophy";
        return exIdList.map(exId=>{
          const def=allExercises.find(e=>e.id===exId);
          if(!def) return null;
          const last=getLastForExercise(exId);
          let weight=def.defaultWeight;
          if(last){
            const days=(Date.now()-new Date(last.workout.date))/86400000;
            const weeks=Math.max(1,Math.round(days/7));
            weight=safeProgressWeight(last.exercise.weight,goal,weeks,def.unit);
          }
          return{id:exId,name:def.name,category:def.category,weight,unit:def.unit,sets,reps,increment:def.increment};
        }).filter(Boolean);
      };

      // Generate per-set rep targets based on scheme
      const buildSetReps=(sets, reps, scheme)=>{
        if(scheme==="dropset"){
          // Each set drops reps: start at reps, decrease by 2 each set
          return Array.from({length:sets},(_,i)=>Math.max(1, reps - i*2));
        } else if(scheme==="pyramid"){
          // Increase to peak then decrease
          const half=Math.floor(sets/2);
          return Array.from({length:sets},(_,i)=>{
            if(i<=half) return reps + i*2;
            return reps + (sets-1-i)*2;
          });
        }
        // standard: all sets same reps
        return Array.from({length:sets},()=>reps);
      };

      const launchWorkout=(tmpl,extras,removed,sets,reps,scheme)=>{
        const allIds=[...tmpl.exercises,...extras].filter(id=>!removed.includes(id));
        const exercises=buildExerciseList(allIds,sets,reps);
        const setRepsMap={};
        exercises.forEach(ex=>{
          setRepsMap[ex.id]=buildSetReps(sets,reps,scheme);
        });
        setActiveWorkout({date:new Date().toISOString(),exercises,completed:false,templateLabel:tmpl.label,setRepsMap,scheme});
        setCurrentExIdx(0);setCompletedSets({});setPerSetData({});setNoteFor({});setSummaryData(null);
        setScreen("workout");
      };

      const launchCustomWorkout=()=>{
        const sr=GOAL_SETS[customGoal];
        const exercises=buildExerciseList(customExIds,sr.sets,sr.reps);
        const setRepsMap={};
        exercises.forEach(ex=>{
          setRepsMap[ex.id]=buildSetReps(sr.sets,sr.reps,"standard");
        });
        setActiveWorkout({date:new Date().toISOString(),exercises,completed:false,templateLabel:"Custom",setRepsMap,scheme:"standard"});
        setCurrentExIdx(0);setCompletedSets({});setPerSetData({});setNoteFor({});setSummaryData(null);
        setScreen("workout");
      };

      const finishWorkout=async()=>{
        const w={...activeWorkout,completed:true};
        await addWorkoutRecord(w);
        const summary={
          templateLabel:w.templateLabel,
          date:w.date,
          exercises:w.exercises.map(ex=>{
            const doneSets=Array.from({length:ex.sets},(_,i)=>!!completedSets[`${ex.id}_${i}`]);
            const completed=doneSets.filter(Boolean).length;
            const last=getLastForExercise(ex.id);
            const improved=last&&ex.weight>last.exercise.weight;
            const note=noteFor[ex.id]||"";
            const matchedGoals=liftGoals.filter(g=>g.exId===ex.id&&ex.weight>=g.targetWeight);
            return{...ex,completedSets:completed,totalSets:ex.sets,improved,note,matchedGoals};
          }),
        };
        setSummaryData(summary);
        setActiveWorkout(null);setActiveTmpl(null);setExtraExIds([]);setRemovedExIds([]);
        setScreen("summary");
      };

      const cancelWorkout=()=>{setActiveWorkout(null);setActiveTmpl(null);setExtraExIds([]);setRemovedExIds([]);setScreen("home");};

      const toggleSet=(exId,i)=>setCompletedSets(p=>({...p,[`${exId}_${i}`]:!p[`${exId}_${i}`]}));

      // Adjust overall weight for exercise (for the ‚àí / + 0.25 buttons)
      const adjustWeight=(exId,delta)=>setActiveWorkout(p=>({...p,exercises:p.exercises.map(e=>e.id===exId?{...e,weight:Math.max(0,+(e.weight+delta).toFixed(2))}:e)}));

      // Adjust per-set weight
      const adjustSetWeight=(exId,setIdx,delta)=>{
        const key=`${exId}_${setIdx}`;
        setPerSetData(p=>{
          const ex=activeWorkout.exercises.find(e=>e.id===exId);
          const current=p[key]?.weight ?? ex.weight;
          return {...p,[key]:{...p[key],weight:Math.max(0,+(current+delta).toFixed(2))}};
        });
      };

      // Adjust per-set reps
      const adjustSetReps=(exId,setIdx,delta)=>{
        const key=`${exId}_${setIdx}`;
        setPerSetData(p=>{
          const currentReps=p[key]?.reps ?? (activeWorkout.setRepsMap?.[exId]?.[setIdx] ?? activeWorkout.exercises.find(e=>e.id===exId)?.reps ?? 10);
          return {...p,[key]:{...p[key],reps:Math.max(1,currentReps+delta)}};
        });
      };

      const setsForEx=(ex)=>Array.from({length:ex.sets},(_,i)=>!!completedSets[`${ex.id}_${i}`]);
      const totalSets=activeWorkout?activeWorkout.exercises.reduce((a,e)=>a+e.sets,0):0;
      const totalDone=activeWorkout?activeWorkout.exercises.reduce((a,ex)=>{setsForEx(ex).forEach(d=>{if(d)a++;});return a;},0):0;

      const saveNewExercise=async(addToWorkout=false)=>{
        if(!newEx.name.trim()) return;
        const ex={id:"custom_"+Date.now(),name:newEx.name.trim(),category:newEx.category,unit:newEx.unit,defaultWeight:Number(newEx.defaultWeight)||0,increment:Number(newEx.increment)||5,custom:true};
        const saved=await doAddCustomEx(ex);
        if(addToWorkout){
          if(activeTmpl) setExtraExIds(p=>[...p,saved.id]);
          else setCustomExIds(p=>[...p,saved.id]);
        }
        setNewEx({name:"",category:"Chest",unit:"lbs",defaultWeight:45,increment:5});
        setModal(null);showToast(ex.name+" added!");
      };

      const saveNewLiftGoal=async()=>{
        if(!newLiftGoal.exId||!newLiftGoal.targetWeight) return;
        const g={exId:newLiftGoal.exId,targetWeight:Number(newLiftGoal.targetWeight),created:new Date().toISOString()};
        await doAddLiftGoal(g);
        setNewLiftGoal({exId:"",targetWeight:""});
        setModal(null);showToast("Goal set!");
      };

      const savePastWorkout=async()=>{
        if(!pastDate) return;
        const exercises=pastRows.filter(r=>r.exId&&r.weight!==""&&r.reps!=="").map(r=>{
          const def=allExercises.find(e=>e.id===r.exId);
          return{id:r.exId,name:def?.name||r.exId,category:def?.category||"Other",weight:Number(r.weight),unit:def?.unit||"lbs",sets:Number(r.sets)||3,reps:Number(r.reps),increment:def?.increment||5};
        });
        if(!exercises.length) return;
        await addWorkoutRecord({date:new Date(pastDate+"T12:00:00").toISOString(),exercises,completed:true,imported:true});
        setPastDate("");setPastRows([{exId:"",weight:"",reps:"",sets:""}]);
        setModal(null);showToast("Past workout imported!");
      };

      // Auto-scroll import list when row added
      const addPastRow=()=>{
        setPastRows(p=>[...p,{exId:"",weight:"",reps:"",sets:""}]);
        setTimeout(()=>pastRowsEndRef.current?.scrollIntoView({behavior:"smooth"}),50);
      };

      // ‚îÄ‚îÄ LIFT GOAL HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const getLiftHistory=(exId)=>{
        const hist=[];
        workouts.forEach(w=>{
          const ex=w.exercises?.find(e=>e.id===exId);
          if(ex) hist.push({date:w.date,weight:ex.weight});
        });
        return hist.sort((a,b)=>new Date(a.date)-new Date(b.date));
      };

      // ‚îÄ‚îÄ HISTORY CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function CalendarView({workouts}) {
        const [calYear,  setCalYear]  = useState(new Date().getFullYear());
        const [calMonth, setCalMonth] = useState(new Date().getMonth());
        const workoutDates=new Set(workouts.map(w=>new Date(w.date).toDateString()));
        const firstDay=new Date(calYear,calMonth,1).getDay();
        const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
        const monthName=new Date(calYear,calMonth).toLocaleDateString("en-US",{month:"long",year:"numeric"});
        const cells=[];
        for(let i=0;i<firstDay;i++) cells.push(null);
        for(let d=1;d<=daysInMonth;d++) cells.push(d);
        const prevMonth=()=>{ if(calMonth===0){setCalMonth(11);setCalYear(y=>y-1);}else setCalMonth(m=>m-1); };
        const nextMonth=()=>{ if(calMonth===11){setCalMonth(0);setCalYear(y=>y+1);}else setCalMonth(m=>m+1); };
        return(
          <div style={{marginTop:16}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
              <button onClick={prevMonth} style={{background:"none",border:"none",color:"var(--gold)",cursor:"pointer",fontSize:20}}>‚Äπ</button>
              <span style={{fontFamily:"'DM Mono',monospace",fontSize:11,letterSpacing:2,color:"var(--cream)",textTransform:"uppercase"}}>{monthName}</span>
              <button onClick={nextMonth} style={{background:"none",border:"none",color:"var(--gold)",cursor:"pointer",fontSize:20}}>‚Ä∫</button>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:3,textAlign:"center"}}>
              {["Su","Mo","Tu","We","Th","Fr","Sa"].map(d=>(
                <div key={d} style={{fontFamily:"'DM Mono',monospace",fontSize:9,color:"var(--muted)",paddingBottom:4,letterSpacing:1}}>{d}</div>
              ))}
              {cells.map((d,i)=>{
                if(!d) return <div key={i}/>;
                const date=new Date(calYear,calMonth,d).toDateString();
                const hasWorkout=workoutDates.has(date);
                const isToday=new Date().toDateString()===date;
                return(
                  <div key={i} style={{
                    borderRadius:6,padding:"6px 2px",
                    background:hasWorkout?"rgba(200,146,42,0.25)":isToday?"rgba(200,146,42,0.06)":"transparent",
                    border:isToday?"1px solid rgba(200,146,42,0.4)":"1px solid transparent",
                    fontFamily:"'DM Mono',monospace",fontSize:12,
                    color:hasWorkout?"var(--gold)":isToday?"var(--cream2)":"var(--muted)",
                    fontWeight:hasWorkout?"600":"400",
                    position:"relative",
                  }}>
                    {d}
                    {hasWorkout&&<div style={{position:"absolute",bottom:2,left:"50%",transform:"translateX(-50%)",width:4,height:4,borderRadius:2,background:"var(--gold)"}}/>}
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ STYLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const s={
        app:       {minHeight:"100vh",background:"var(--bg)",color:"var(--cream)",fontFamily:"'DM Sans',sans-serif",position:"relative"},
        content:   {position:"relative",zIndex:2,maxWidth:480,margin:"0 auto",padding:"env(safe-area-inset-top, 20px) 20px 110px"},
        contentPt: {paddingTop:"max(env(safe-area-inset-top, 20px), 20px)"},
        header:    {display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20,paddingTop:8},
        logo:      {fontFamily:"'Playfair Display',serif",fontSize:22,fontWeight:900,color:"var(--gold)",letterSpacing:1},
        card:      {background:"var(--surface)",border:"1px solid var(--border)",borderRadius:12,padding:18,marginBottom:10},
        cardWarm:  {background:"rgba(200,146,42,0.08)",border:"1px solid rgba(200,146,42,0.3)",borderRadius:12,padding:18,marginBottom:10},
        label:     {fontFamily:"'DM Mono',monospace",fontSize:10,letterSpacing:3,color:"var(--muted)",textTransform:"uppercase",display:"block",marginBottom:8},
        input:     {background:"var(--surface2)",border:"1px solid var(--border)",borderRadius:8,padding:"11px 14px",color:"var(--cream)",fontFamily:"'DM Sans',sans-serif",fontSize:15,width:"100%",outline:"none",boxSizing:"border-box"},
        select:    {background:"var(--surface2)",border:"1px solid var(--border)",borderRadius:8,padding:"11px 14px",color:"var(--cream)",fontFamily:"'DM Sans',sans-serif",fontSize:15,width:"100%",outline:"none",boxSizing:"border-box"},
        btn:       {background:"var(--gold)",color:"var(--bg)",border:"none",borderRadius:8,padding:"14px 24px",fontFamily:"'DM Mono',monospace",fontWeight:500,fontSize:13,letterSpacing:2,cursor:"pointer",width:"100%",display:"block",marginTop:8,textTransform:"uppercase"},
        btnOutline:{background:"transparent",color:"var(--gold)",border:"1px solid rgba(200,146,42,0.5)",borderRadius:8,padding:"12px 20px",fontFamily:"'DM Mono',monospace",fontSize:12,letterSpacing:2,cursor:"pointer",textTransform:"uppercase"},
        btnSm:     {background:"var(--surface2)",color:"var(--gold2)",border:"1px solid var(--border2)",borderRadius:6,padding:"7px 12px",fontFamily:"'DM Mono',monospace",fontSize:10,letterSpacing:2,cursor:"pointer",textTransform:"uppercase"},
        btnDanger: {background:"rgba(196,75,43,0.12)",color:"var(--brick2)",border:"1px solid rgba(196,75,43,0.35)",borderRadius:8,padding:"10px 18px",fontFamily:"'DM Mono',monospace",fontSize:11,letterSpacing:1,cursor:"pointer",textTransform:"uppercase"},
        tag:       {display:"inline-block",background:"rgba(200,146,42,0.12)",border:"1px solid rgba(200,146,42,0.35)",borderRadius:4,padding:"3px 9px",fontFamily:"'DM Mono',monospace",fontSize:10,letterSpacing:2,color:"var(--gold2)",textTransform:"uppercase"},
        navBar:    {position:"fixed",bottom:0,left:0,right:0,background:"var(--bg2)",borderTop:"1px solid var(--border)",display:"flex",justifyContent:"space-around",paddingBottom:"env(safe-area-inset-bottom, 12px)",paddingTop:10,zIndex:100},
        navBtn:    {background:"none",border:"none",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:3,fontFamily:"'DM Mono',monospace",fontSize:8,letterSpacing:2,padding:"4px 16px",textTransform:"uppercase"},
        setBtn:    {width:46,height:46,borderRadius:8,border:"1px solid var(--border2)",background:"var(--surface)",color:"var(--gold)",fontSize:22,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},
        setDot:    (done)=>({width:46,height:46,borderRadius:8,border:done?"none":"1px solid var(--border2)",background:done?"var(--gold)":"var(--surface)",color:done?"var(--bg)":"var(--muted)",fontFamily:"'DM Mono',monospace",fontSize:13,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.15s",fontWeight:500}),
      };

      const Toast=toast?<div style={{position:"fixed",top:24,left:"50%",transform:"translateX(-50%)",background:"var(--gold)",color:"var(--bg)",padding:"11px 22px",borderRadius:6,fontFamily:"'DM Mono',monospace",fontSize:12,letterSpacing:2,fontWeight:500,zIndex:600,boxShadow:"0 6px 24px rgba(200,146,42,0.4)",whiteSpace:"nowrap",textTransform:"uppercase"}}>{toast}</div>:null;

      const NavBar=({active})=>(
        <nav style={s.navBar}>
          {[["‚äï","Train","home"],["‚óé","Goals","goals"],["‚ñ§","History","history"],["‚óâ","Profile","profile"]].map(([icon,lbl,scr])=>(
            <button key={scr} style={{...s.navBtn,color:active===scr?"var(--gold)":"var(--muted)"}} onClick={()=>setScreen(scr)}>
              <span style={{fontSize:20,lineHeight:1}}>{icon}</span>{lbl}
            </button>
          ))}
        </nav>
      );

      // ‚îÄ‚îÄ EXERCISE FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // FIX: Use controlled input with key to prevent re-render focus loss on iPhone
      const ExerciseFormFields=()=>(
        <div style={{display:"flex",flexDirection:"column",gap:12}}>
          <div>
            <span style={s.label}>Name</span>
            <input
              style={s.input}
              placeholder="e.g. Cable Fly"
              value={newEx.name}
              onChange={e=>{const v=e.target.value;setNewEx(p=>({...p,name:v}));}}
              autoComplete="off"
              autoCorrect="off"
              autoCapitalize="words"
            />
          </div>
          <div><span style={s.label}>Category</span><select style={s.select} value={newEx.category} onChange={e=>setNewEx(p=>({...p,category:e.target.value}))}>{CATEGORIES.map(c=><option key={c}>{c}</option>)}</select></div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <div><span style={s.label}>Unit</span><select style={s.select} value={newEx.unit} onChange={e=>setNewEx(p=>({...p,unit:e.target.value}))}><option value="lbs">lbs</option><option value="kg">kg</option><option value="reps">Bodyweight</option></select></div>
            <div><span style={s.label}>Starting Weight</span><input style={s.input} type="number" value={newEx.defaultWeight} onChange={e=>setNewEx(p=>({...p,defaultWeight:e.target.value}))} disabled={newEx.unit==="reps"}/></div>
          </div>
          <div><span style={s.label}>Increment Per Session</span><input style={s.input} type="number" value={newEx.increment} onChange={e=>setNewEx(p=>({...p,increment:e.target.value}))}/></div>
        </div>
      );

      // ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const renderModal=()=>{
        if(modal==="browseAdd"){
          const activeIds=activeTmpl?[...activeTmpl.exercises,...extraExIds].filter(id=>!removedExIds.includes(id)):customExIds;
          const available=allExercises.filter(ex=>!activeIds.includes(ex.id));
          return(
            <Modal onClose={()=>setModal(null)}>
              <span style={{...s.label,fontSize:12,marginBottom:16}}>Add Exercise</span>
              <div style={{maxHeight:"55vh",overflowY:"auto",marginBottom:12}}>
                {CATEGORIES.map(cat=>{
                  const ces=available.filter(e=>e.category===cat);
                  if(!ces.length) return null;
                  return(
                    <div key={cat} style={{marginBottom:14}}>
                      <span style={{...s.label,fontSize:9}}>{cat}</span>
                      <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                        {ces.map(ex=>(
                          <button key={ex.id} onClick={()=>{
                            if(activeTmpl) setExtraExIds(p=>[...p,ex.id]);
                            else setCustomExIds(p=>[...p,ex.id]);
                            setModal(null);showToast(ex.name+" added!");
                          }} style={{background:"var(--surface2)",border:"1px solid var(--border)",borderRadius:6,padding:"7px 11px",color:"var(--cream2)",fontSize:13,cursor:"pointer"}}>
                            {ex.name}{ex.custom?" ‚òÖ":""}
                          </button>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
              <button style={{...s.btnOutline,width:"100%",fontSize:11}} onClick={()=>setModal("createAndAdd")}>+ Create New Exercise</button>
            </Modal>
          );
        }
        if(modal==="createAndAdd") return(
          <ModalStrict onClose={()=>setModal(null)}>
            <span style={{...s.label,fontSize:12,marginBottom:16}}>Create & Add Exercise</span>
            <ExerciseFormFields/>
            <button style={{...s.btn,marginTop:12}} onClick={()=>saveNewExercise(true)}>Create & Add</button>
          </ModalStrict>
        );
        if(modal==="addExercise") return(
          <ModalStrict onClose={()=>setModal(null)}>
            <span style={{...s.label,fontSize:12,marginBottom:16}}>Add Custom Exercise</span>
            <ExerciseFormFields/>
            <button style={{...s.btn,marginTop:12}} onClick={()=>saveNewExercise(false)}>Add Exercise</button>
          </ModalStrict>
        );
        if(modal==="addLiftGoal") return(
          <Modal onClose={()=>setModal(null)}>
            <span style={{...s.label,fontSize:12,marginBottom:4}}>Set a Lift Goal</span>
            <p style={{color:"var(--muted)",fontSize:13,marginBottom:16,lineHeight:1.5}}>Choose an exercise and a target weight. IRONFORM will chart your progress and project when you'll get there.</p>
            <div style={{display:"flex",flexDirection:"column",gap:12}}>
              <div>
                <span style={s.label}>Exercise</span>
                <select style={s.select} value={newLiftGoal.exId} onChange={e=>setNewLiftGoal(p=>({...p,exId:e.target.value}))}>
                  <option value="">Select exercise...</option>
                  {CATEGORIES.map(cat=>{const ces=allExercises.filter(e=>e.category===cat);if(!ces.length)return null;return(<optgroup key={cat} label={cat}>{ces.map(ex=><option key={ex.id} value={ex.id}>{ex.name}</option>)}</optgroup>);})}
                </select>
              </div>
              <div>
                <span style={s.label}>Target Weight (lbs)</span>
                <input style={s.input} type="number" placeholder="e.g. 135" value={newLiftGoal.targetWeight} onChange={e=>setNewLiftGoal(p=>({...p,targetWeight:e.target.value}))}/>
              </div>
            </div>
            <button style={{...s.btn,marginTop:16}} onClick={saveNewLiftGoal}>Set Goal</button>
          </Modal>
        );
        // ‚òÖ Past workout modal: ModalStrict requires X to close
        if(modal==="logPastWorkout") return(
          <ModalStrict onClose={()=>setModal(null)}>
            <span style={{...s.label,fontSize:12,marginBottom:4}}>Log Past Workout</span>
            <p style={{color:"var(--muted)",fontSize:13,marginBottom:16,lineHeight:1.5}}>Enter a previous session to calibrate your weight projections.</p>
            <div style={{marginBottom:16}}><span style={s.label}>Date</span><input style={s.input} type="date" value={pastDate} onChange={e=>setPastDate(e.target.value)}/></div>
            <div style={{maxHeight:"45vh",overflowY:"auto"}}>
              {pastRows.map((row,i)=>(
                <div key={i} style={{...s.card,padding:14,marginBottom:8}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                    <span style={{...s.label,marginBottom:0}}>Exercise {i+1}</span>
                    {pastRows.length>1&&<button style={{background:"none",border:"none",color:"var(--brick2)",cursor:"pointer",fontSize:18}} onClick={()=>setPastRows(p=>p.filter((_,idx)=>idx!==i))}>√ó</button>}
                  </div>
                  <div style={{display:"flex",flexDirection:"column",gap:8}}>
                    <select style={s.select} value={row.exId} onChange={e=>setPastRows(p=>p.map((r,idx)=>idx===i?{...r,exId:e.target.value}:r))}>
                      <option value="">Select exercise...</option>
                      {CATEGORIES.map(cat=>{const ces=allExercises.filter(e=>e.category===cat);if(!ces.length)return null;return(<optgroup key={cat} label={cat}>{ces.map(ex=><option key={ex.id} value={ex.id}>{ex.name}</option>)}</optgroup>);})}
                    </select>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
                      {[["Weight","weight","135"],["Reps","reps","5"],["Sets","sets","3"]].map(([lbl,key,ph])=>(
                        <div key={key}><span style={{...s.label,fontSize:9}}>{lbl}</span><input style={{...s.input,padding:"9px 10px",fontSize:14}} type="number" placeholder={ph} value={row[key]} onChange={e=>setPastRows(p=>p.map((r,idx)=>idx===i?{...r,[key]:e.target.value}:r))}/></div>
                      ))}
                    </div>
                  </div>
                </div>
              ))}
              <div ref={pastRowsEndRef}/>
            </div>
            <button style={{...s.btnOutline,width:"100%",marginBottom:10,marginTop:8,fontSize:11}} onClick={addPastRow}>+ Add Another Exercise</button>
            <button style={s.btn} onClick={savePastWorkout}>Save Past Workout</button>
          </ModalStrict>
        );
        // History edit modal
        if(modal==="editWorkout"&&editingWorkout) {
          const ew=editingWorkout;
          return(
            <ModalStrict onClose={()=>{setModal(null);setEditingWorkout(null);}}>
              <span style={{...s.label,fontSize:12,marginBottom:4}}>Edit Workout</span>
              <p style={{color:"var(--muted)",fontSize:12,marginBottom:14,fontFamily:"'DM Mono',monospace",letterSpacing:0.5}}>
                {new Date(ew.date).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"})}
              </p>
              <div style={{maxHeight:"55vh",overflowY:"auto"}}>
                {ew.exercises.map((ex,ei)=>(
                  <div key={ei} style={{...s.card,padding:12,marginBottom:8}}>
                    <div style={{fontWeight:600,fontSize:14,color:"var(--cream)",marginBottom:8}}>{ex.name}</div>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
                      {[["Weight","weight"],["Reps","reps"],["Sets","sets"]].map(([lbl,key])=>(
                        <div key={key}>
                          <span style={{...s.label,fontSize:9}}>{lbl}</span>
                          <input style={{...s.input,padding:"8px 10px",fontSize:13}} type="number" value={ex[key]||""} onChange={e=>{
                            const val=e.target.value;
                            setEditingWorkout(prev=>({...prev,exercises:prev.exercises.map((x,xi)=>xi===ei?{...x,[key]:val}:x)}));
                          }}/>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
              <button style={{...s.btn,marginTop:12}} onClick={async()=>{
                const updated={...ew,exercises:ew.exercises.map(ex=>({...ex,weight:Number(ex.weight)||0,reps:Number(ex.reps)||0,sets:Number(ex.sets)||1}))};
                await updateWorkoutRecord(updated);
                setModal(null);setEditingWorkout(null);showToast("Workout updated!");
              }}>Save Changes</button>
            </ModalStrict>
          );
        }
        if(modal==="versionHistory") return(
          <Modal onClose={()=>setModal(null)}>
            <div style={{fontFamily:"'Playfair Display',serif",fontSize:20,color:"var(--gold)",marginBottom:4}}>Release History</div>
            {RELEASE_HISTORY.map(r=>(
              <div key={r.version} style={{...s.card,marginBottom:10,marginTop:10}}>
                <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}>
                  <span style={{fontFamily:"'DM Mono',monospace",fontSize:13,color:"var(--gold)",fontWeight:600}}>v{r.version}</span>
                  <span style={{fontFamily:"'DM Mono',monospace",fontSize:10,color:"var(--muted)"}}>{r.date}</span>
                </div>
                {r.features.map((f,i)=>(
                  <div key={i} style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--cream2)",padding:"4px 0",borderBottom:"1px solid var(--border)",lineHeight:1.5}}>
                    ¬∑ {f}
                  </div>
                ))}
              </div>
            ))}
          </Modal>
        );
        return null;
      };

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // SCREENS
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      if(authUser===undefined||dataLoading) return(
        <div style={{...s.app,display:"flex",alignItems:"center",justifyContent:"center"}}>
          <div style={{textAlign:"center",position:"relative",zIndex:2}}>
            <div style={{fontFamily:"'Playfair Display',serif",fontSize:28,color:"var(--gold)",letterSpacing:2,marginBottom:10}}>IRONFORM</div>
            <div style={{fontFamily:"'DM Mono',monospace",fontSize:10,color:"var(--muted)",letterSpacing:4}}>LOADING...</div>
          </div>
        </div>
      );

      if(!authUser) return(
        <div style={{...s.app,display:"flex",alignItems:"center",justifyContent:"center"}}>
          <div style={{position:"relative",zIndex:2,width:"100%",maxWidth:400,padding:"0 28px",textAlign:"center"}}>
            <div style={{display:"inline-block",border:"2px solid var(--gold)",borderRadius:"50%",width:100,height:100,lineHeight:"96px",fontSize:36,marginBottom:24,color:"var(--gold)",background:"var(--surface)"}}>
              üèãÔ∏è
            </div>
            <div style={{fontFamily:"'Playfair Display',serif",fontSize:38,fontWeight:900,color:"var(--gold)",letterSpacing:2,marginBottom:4}}>IRONFORM</div>
            <div style={{fontFamily:"'DM Mono',monospace",fontSize:10,letterSpacing:4,color:"var(--muted)",marginBottom:32,textTransform:"uppercase"}}>Personal Strength Journal</div>
            <div style={{width:60,height:1,background:"var(--border2)",margin:"0 auto 32px"}}/>
            <button onClick={handleSignIn} disabled={signingIn} style={{background:"var(--cream)",color:"var(--bg)",border:"none",borderRadius:8,padding:"15px 20px",fontFamily:"'DM Mono',monospace",fontWeight:500,fontSize:12,letterSpacing:2,cursor:"pointer",width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:12,opacity:signingIn?0.7:1,textTransform:"uppercase"}}>
              <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
              {signingIn?"Signing in...":"Sign in with Google"}
            </button>
            {signInErr&&<div style={{marginTop:14,color:"var(--brick2)",fontSize:13,fontFamily:"'DM Mono',monospace"}}>{signInErr}</div>}
          </div>
        </div>
      );

      // ‚îÄ‚îÄ PRESET PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(screen==="preset_preview"&&activeTmpl){
        const tmpl=activeTmpl;
        const goal=profile?.goal||"hypertrophy";
        const allIds=[...tmpl.exercises,...extraExIds].filter(id=>!removedExIds.includes(id));
        return(
          <div style={s.app}>
            {renderModal()}{Toast}
            <div style={{...s.content,...s.contentPt}}>
              <div style={s.header}>
                <div style={s.logo}>IRONFORM</div>
                <span style={{...s.tag,background:tmpl.accentDim,border:`1px solid ${tmpl.accentBorder}`,color:tmpl.accent}}>{tmpl.emoji} {tmpl.label}</span>
              </div>
              <BackBtn onClick={()=>{setActiveTmpl(null);setExtraExIds([]);setRemovedExIds([]);setScreen("home");}}/>

              <h2 style={{fontFamily:"'Playfair Display',serif",fontSize:26,color:"var(--cream)",marginBottom:16}}>{tmpl.label}</h2>

              <div style={{...s.card,marginBottom:14}}>
                <span style={s.label}>Set & Rep Scheme</span>
                <div style={{display:"flex",justifyContent:"space-around",paddingTop:8}}>
                  <Stepper value={previewSets} onChange={setPreviewSets} min={1} label="Sets"/>
                  <div style={{width:1,background:"var(--border)"}}/>
                  <Stepper value={previewReps} onChange={setPreviewReps} min={1} label="Reps"/>
                </div>
                {/* Rep scheme selector */}
                <div style={{marginTop:14}}>
                  <span style={{...s.label,marginBottom:6}}>Rep Scheme</span>
                  <div style={{display:"flex",gap:6}}>
                    {[["standard","Standard"],["dropset","Drop Set"],["pyramid","Pyramid"]].map(([key,lbl])=>(
                      <button key={key} onClick={()=>setRepScheme(key)} style={{
                        flex:1,padding:"8px 4px",borderRadius:6,fontSize:11,fontFamily:"'DM Mono',monospace",letterSpacing:1,cursor:"pointer",textTransform:"uppercase",
                        background:repScheme===key?"rgba(200,146,42,0.18)":"var(--surface2)",
                        border:repScheme===key?"1px solid rgba(200,146,42,0.5)":"1px solid var(--border)",
                        color:repScheme===key?"var(--gold)":"var(--muted)",
                      }}>{lbl}</button>
                    ))}
                  </div>
                  {repScheme!=="standard"&&(
                    <div style={{marginTop:8,fontFamily:"'DM Mono',monospace",fontSize:10,color:"var(--muted)",letterSpacing:0.5,lineHeight:1.5}}>
                      {repScheme==="dropset"&&`Sets: ${buildSetReps(previewSets,previewReps,"dropset").join(" ‚Üí ")} reps`}
                      {repScheme==="pyramid"&&`Sets: ${buildSetReps(previewSets,previewReps,"pyramid").join(" ‚Üí ")} reps`}
                    </div>
                  )}
                </div>
              </div>

              <span style={s.label}>Exercises ({allIds.length})</span>
              {allIds.map(exId=>{
                const def=allExercises.find(e=>e.id===exId);
                if(!def) return null;
                const last=getLastForExercise(exId);
                const weight=last?safeProgressWeight(last.exercise.weight,goal,Math.max(1,Math.round((Date.now()-new Date(last.workout.date))/86400000/7)),def.unit):def.defaultWeight;
                const isExtra=extraExIds.includes(exId);
                return(
                  <div key={exId} style={{...s.card,marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 14px"}}>
                    <div>
                      <div style={{fontWeight:600,fontSize:15,color:"var(--cream)",display:"flex",alignItems:"center",gap:8}}>
                        {def.name}
                        {isExtra&&<span style={{...s.tag,fontSize:8,padding:"2px 6px",color:"var(--blue2)",background:"rgba(74,108,140,0.15)",border:"1px solid rgba(74,108,140,0.35)"}}>Added</span>}
                      </div>
                      <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)",marginTop:3}}>
                        {def.unit==="reps"?"Bodyweight":`${weight} ${def.unit}`}
                        {last?` ¬∑ last ${new Date(last.workout.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})}`:" ¬∑ first time"}
                      </div>
                    </div>
                    {/* ‚òÖ All exercises can be removed */}
                    <button onClick={()=>{
                      if(isExtra) setExtraExIds(p=>p.filter(id=>id!==exId));
                      else setRemovedExIds(p=>[...p,exId]);
                    }} style={{background:"none",border:"none",color:"var(--brick2)",cursor:"pointer",fontSize:20,flexShrink:0}}>√ó</button>
                  </div>
                );
              })}

              <button style={{...s.btnOutline,width:"100%",marginBottom:10,marginTop:6}} onClick={()=>setModal("browseAdd")}>+ Add Exercise Today</button>
              <button style={s.btn} onClick={()=>launchWorkout(tmpl,extraExIds,removedExIds,previewSets,previewReps,repScheme)}>Begin {tmpl.label}</button>
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ CUSTOM BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(screen==="custom_builder") return(
        <div style={s.app}>
          {renderModal()}{Toast}
          <div style={{...s.content,...s.contentPt}}>
            <div style={s.header}><div style={s.logo}>IRONFORM</div><span style={s.tag}>Custom</span></div>
            <BackBtn onClick={()=>{setCustomExIds([]);setCustomGoal("hypertrophy");setScreen("home");}}/>
            <h2 style={{fontFamily:"'Playfair Display',serif",fontSize:26,color:"var(--cream)",marginBottom:6}}>Build Your Workout</h2>
            <p style={{color:"var(--muted)",fontSize:14,marginBottom:18,lineHeight:1.5}}>Pick your exercises, then go.</p>

            <div style={{...s.card,marginBottom:14}}>
              <span style={s.label}>Training Goal</span>
              <div style={{display:"flex",gap:8,flexWrap:"wrap",marginTop:4}}>
                {Object.entries(GOALS).map(([key,g])=>(
                  <button key={key} onClick={()=>setCustomGoal(key)} style={{background:customGoal===key?"rgba(200,146,42,0.18)":"var(--surface2)",border:customGoal===key?"1px solid rgba(200,146,42,0.5)":"1px solid var(--border)",borderRadius:6,padding:"8px 13px",color:customGoal===key?"var(--gold)":"var(--muted)",fontSize:13,cursor:"pointer"}}>
                    {g.label}
                  </button>
                ))}
              </div>
            </div>

            {customExIds.length>0&&(
              <div style={{...s.card,marginBottom:14}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
                  <span style={s.label}>{customExIds.length} Selected</span>
                  <button style={{background:"none",border:"none",color:"var(--brick2)",cursor:"pointer",fontFamily:"'DM Mono',monospace",fontSize:9,letterSpacing:2,textTransform:"uppercase"}} onClick={()=>setCustomExIds([])}>Clear All</button>
                </div>
                {customExIds.map(exId=>{
                  const def=allExercises.find(e=>e.id===exId);
                  if(!def) return null;
                  return(
                    <div key={exId} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:"1px solid var(--border)"}}>
                      <span style={{fontSize:14,color:"var(--cream)"}}>{def.name}</span>
                      <button onClick={()=>setCustomExIds(p=>p.filter(id=>id!==exId))} style={{background:"none",border:"none",color:"var(--brick2)",cursor:"pointer",fontSize:18}}>√ó</button>
                    </div>
                  );
                })}
              </div>
            )}

            <div style={s.card}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
                <span style={s.label}>Browse Exercises</span>
                <button style={s.btnSm} onClick={()=>{setActiveTmpl(null);setModal("browseAdd");}}>+ Add</button>
              </div>
              {CATEGORIES.map(cat=>{
                const ces=allExercises.filter(e=>e.category===cat&&!customExIds.includes(e.id));
                if(!ces.length) return null;
                return(
                  <div key={cat} style={{marginBottom:13}}>
                    <span style={{...s.label,fontSize:9}}>{cat}</span>
                    <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                      {ces.map(ex=>(
                        <button key={ex.id} onClick={()=>setCustomExIds(p=>[...p,ex.id])} style={{background:"var(--surface2)",border:"1px solid var(--border)",borderRadius:6,padding:"7px 11px",color:"var(--cream2)",fontSize:13,cursor:"pointer"}}>
                          {ex.name}{ex.custom?" ‚òÖ":""}
                        </button>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
            <button style={{...s.btn,opacity:customExIds.length<1?0.4:1}} onClick={()=>customExIds.length>=1&&launchCustomWorkout()}>
              Begin Workout ({customExIds.length} exercise{customExIds.length!==1?"s":""})
            </button>
          </div>
        </div>
      );

      // ‚îÄ‚îÄ ACTIVE WORKOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(screen==="workout"&&activeWorkout){
        const exercises=activeWorkout.exercises;
        const ex=exercises[currentExIdx];
        const done=setsForEx(ex);
        const allDone=done.every(Boolean);
        const lastRec=getLastForExercise(ex.id);
        const isLast=currentExIdx===exercises.length-1;
        const progress=totalSets>0?totalDone/totalSets:0;
        const setRepsArr=activeWorkout.setRepsMap?.[ex.id]||Array(ex.sets).fill(ex.reps);

        return(
          <div style={s.app}>
            {Toast}
            <div style={{...s.content,...s.contentPt}}>
              <div style={s.header}>
                <div style={s.logo}>IRONFORM</div>
                <button style={s.btnDanger} onClick={cancelWorkout}>Cancel</button>
              </div>

              {/* Progress */}
              <div style={{marginBottom:18}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                  <span style={{...s.label,marginBottom:0}}>{activeWorkout.templateLabel} ¬∑ {currentExIdx+1} of {exercises.length}</span>
                  <span style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--gold)"}}>{totalDone}/{totalSets} sets</span>
                </div>
                <div style={{height:3,background:"var(--surface2)",borderRadius:2,overflow:"hidden"}}>
                  <div style={{height:"100%",width:`${progress*100}%`,background:"var(--gold)",borderRadius:2,transition:"width 0.4s ease"}}/>
                </div>
                <div style={{display:"flex",gap:5,marginTop:10,flexWrap:"wrap"}}>
                  {exercises.map((e,i)=>{
                    const exDone=setsForEx(e).every(Boolean);
                    const isCurrent=i===currentExIdx;
                    return(<button key={i} onClick={()=>setCurrentExIdx(i)} style={{width:isCurrent?24:8,height:8,borderRadius:4,border:"none",cursor:"pointer",background:isCurrent?"var(--gold)":exDone?"rgba(200,146,42,0.5)":"var(--surface2)",transition:"all 0.2s",padding:0,flexShrink:0}}/>);
                  })}
                </div>
              </div>

              {/* Exercise card */}
              <div style={{...s.card,padding:22,marginBottom:12}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:6}}>
                  <div>
                    <div style={{fontFamily:"'Playfair Display',serif",fontWeight:700,fontSize:26,lineHeight:1.2,color:"var(--cream)"}}>{ex.name}</div>
                    <div style={{fontFamily:"'DM Mono',monospace",color:"var(--muted)",fontSize:12,marginTop:4,letterSpacing:1}}>
                      {ex.sets} sets ¬∑ {activeWorkout.scheme!=="standard"?activeWorkout.scheme:"standard"} scheme
                    </div>
                  </div>
                  {allDone&&<div style={{color:"var(--green2)",fontSize:26}}>‚úì</div>}
                </div>

                {lastRec&&(
                  <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)",marginBottom:16,background:"var(--surface2)",borderRadius:6,padding:"8px 12px",letterSpacing:0.5}}>
                    Last: {lastRec.exercise.weight}{lastRec.exercise.unit!=="reps"?" "+lastRec.exercise.unit:""} ¬∑ {new Date(lastRec.workout.date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}
                  </div>
                )}

                {/* Overall weight (¬±0.25) */}
                <div style={{display:"flex",alignItems:"center",gap:14,marginBottom:16,justifyContent:"center"}}>
                  <div style={{display:"flex",flexDirection:"column",gap:4}}>
                    <button style={s.setBtn} onClick={()=>adjustWeight(ex.id,-1)}>‚àí</button>
                    <button style={{...s.setBtn,fontSize:14,height:32}} onClick={()=>adjustWeight(ex.id,-0.25)}>-.25</button>
                  </div>
                  <div style={{textAlign:"center",minWidth:90}}>
                    <div style={{fontFamily:"'Playfair Display',serif",fontSize:52,fontWeight:900,color:"var(--gold)",lineHeight:1}}>{ex.weight}</div>
                    <div style={{fontFamily:"'DM Mono',monospace",fontSize:10,color:"var(--muted)",letterSpacing:3,marginTop:2}}>{ex.unit==="reps"?"BODYWEIGHT":ex.unit.toUpperCase()}</div>
                    <div style={{fontFamily:"'DM Mono',monospace",fontSize:9,color:"var(--muted)",marginTop:2}}>BASE WEIGHT</div>
                  </div>
                  <div style={{display:"flex",flexDirection:"column",gap:4}}>
                    <button style={s.setBtn} onClick={()=>adjustWeight(ex.id,1)}>+</button>
                    <button style={{...s.setBtn,fontSize:14,height:32}} onClick={()=>adjustWeight(ex.id,0.25)}>+.25</button>
                  </div>
                </div>

                {/* Per-set controls */}
                <span style={{...s.label,marginBottom:10}}>Sets ‚Äî tap to complete, adjust per-set weight & reps</span>
                <div style={{display:"flex",flexDirection:"column",gap:8,marginBottom:14}}>
                  {done.map((d,i)=>{
                    const setKey=`${ex.id}_${i}`;
                    const setWeight=perSetData[setKey]?.weight ?? ex.weight;
                    const setReps=perSetData[setKey]?.reps ?? setRepsArr[i];
                    return(
                      <div key={i} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",borderRadius:8,background:d?"rgba(200,146,42,0.12)":"var(--surface2)",border:d?"1px solid rgba(200,146,42,0.35)":"1px solid var(--border)"}}>
                        {/* Toggle */}
                        <button style={{...s.setDot(d),flexShrink:0,width:36,height:36,fontSize:12}} onClick={()=>toggleSet(ex.id,i)}>{d?"‚úì":`S${i+1}`}</button>
                        {/* Per-set weight */}
                        <div style={{display:"flex",alignItems:"center",gap:4,flex:1}}>
                          <button onClick={()=>adjustSetWeight(ex.id,i,-0.25)} style={{background:"var(--surface)",border:"1px solid var(--border2)",borderRadius:4,width:26,height:26,color:"var(--gold)",cursor:"pointer",fontSize:14,flexShrink:0}}>‚àí</button>
                          <div style={{textAlign:"center",minWidth:44}}>
                            <div style={{fontFamily:"'DM Mono',monospace",fontSize:13,color:"var(--gold)",fontWeight:500}}>{setWeight}</div>
                            <div style={{fontFamily:"'DM Mono',monospace",fontSize:8,color:"var(--muted)"}}>lbs</div>
                          </div>
                          <button onClick={()=>adjustSetWeight(ex.id,i,0.25)} style={{background:"var(--surface)",border:"1px solid var(--border2)",borderRadius:4,width:26,height:26,color:"var(--gold)",cursor:"pointer",fontSize:14,flexShrink:0}}>+</button>
                        </div>
                        {/* Per-set reps */}
                        <div style={{display:"flex",alignItems:"center",gap:4}}>
                          <button onClick={()=>adjustSetReps(ex.id,i,-1)} style={{background:"var(--surface)",border:"1px solid var(--border2)",borderRadius:4,width:26,height:26,color:"var(--cream2)",cursor:"pointer",fontSize:14,flexShrink:0}}>‚àí</button>
                          <div style={{textAlign:"center",minWidth:30}}>
                            <div style={{fontFamily:"'DM Mono',monospace",fontSize:13,color:"var(--cream)",fontWeight:500}}>{setReps}</div>
                            <div style={{fontFamily:"'DM Mono',monospace",fontSize:8,color:"var(--muted)"}}>reps</div>
                          </div>
                          <button onClick={()=>adjustSetReps(ex.id,i,1)} style={{background:"var(--surface)",border:"1px solid var(--border2)",borderRadius:4,width:26,height:26,color:"var(--cream2)",cursor:"pointer",fontSize:14,flexShrink:0}}>+</button>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <input style={{...s.input,fontSize:13,padding:"10px 12px"}} placeholder="Notes..." value={noteFor[ex.id]||""} onChange={e=>setNoteFor(p=>({...p,[ex.id]:e.target.value}))}/>
              </div>

              {/* Nav */}
              <div style={{display:"grid",gridTemplateColumns:currentExIdx>0?"1fr 1fr":"1fr",gap:10}}>
                {currentExIdx>0&&(
                  <button style={{...s.btnOutline,width:"100%",textAlign:"center"}} onClick={()=>setCurrentExIdx(i=>i-1)}>‚Üê Prev</button>
                )}
                {!isLast?(
                  <button style={s.btn} onClick={()=>setCurrentExIdx(i=>i+1)}>Next ‚Üí</button>
                ):(
                  <button style={{...s.btn,background:progress>=0.3?"var(--gold)":"rgba(200,146,42,0.3)",color:progress>=0.3?"var(--bg)":"var(--muted)",marginTop:0}} onClick={progress>=0.3?finishWorkout:undefined}>
                    {progress>=1?"Finish Workout ‚úì":`Finish Early (${totalDone}/${totalSets})`}
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ WORKOUT SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(screen==="summary"&&summaryData){
        const sd=summaryData;
        const achievedGoals=sd.exercises.flatMap(ex=>ex.matchedGoals||[]);
        return(
          <div style={s.app}>
            {renderModal()}{Toast}
            <div style={{...s.content,...s.contentPt}}>
              <div style={s.header}>
                <div style={s.logo}>IRONFORM</div>
                <span style={s.tag}>{sd.templateLabel}</span>
              </div>

              <div style={{...s.cardWarm,textAlign:"center",padding:28,marginBottom:16}}>
                <div style={{fontSize:36,marginBottom:8}}>üèÜ</div>
                <div style={{fontFamily:"'Playfair Display',serif",fontSize:28,color:"var(--gold)",marginBottom:4}}>Session Complete</div>
                <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)",letterSpacing:2}}>
                  {new Date(sd.date).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})}
                </div>
                <div style={{display:"flex",justifyContent:"center",gap:24,marginTop:18}}>
                  {[
                    {label:"Exercises",value:sd.exercises.length},
                    {label:"Sets Done",value:sd.exercises.reduce((a,e)=>a+e.completedSets,0)},
                    {label:"PRs",value:sd.exercises.filter(e=>e.improved).length},
                  ].map(stat=>(
                    <div key={stat.label} style={{textAlign:"center"}}>
                      <div style={{fontFamily:"'Playfair Display',serif",fontSize:26,color:"var(--cream)",lineHeight:1}}>{stat.value}</div>
                      <div style={{fontFamily:"'DM Mono',monospace",fontSize:9,color:"var(--muted)",letterSpacing:2,marginTop:3,textTransform:"uppercase"}}>{stat.label}</div>
                    </div>
                  ))}
                </div>
              </div>

              {achievedGoals.length>0&&(
                <div style={{...s.card,background:"rgba(74,124,89,0.12)",border:"1px solid rgba(74,124,89,0.35)",marginBottom:10}}>
                  <span style={{...s.label,color:"var(--green2)"}}>üéØ Goals Achieved This Session</span>
                  {achievedGoals.map((g,i)=>{
                    const def=allExercises.find(e=>e.id===g.exId);
                    return(
                      <div key={i} style={{fontFamily:"'DM Mono',monospace",fontSize:12,color:"var(--green2)",padding:"4px 0",borderBottom:"1px solid rgba(74,124,89,0.2)"}}>
                        ‚úì {def?.name||g.exId} ‚Äî {g.targetWeight} lbs
                      </div>
                    );
                  })}
                </div>
              )}

              <span style={s.label}>Exercise Breakdown</span>
              {sd.exercises.map(ex=>(
                <div key={ex.id} style={{...s.card,marginBottom:8,padding:"13px 15px"}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                    <div style={{flex:1}}>
                      <div style={{fontWeight:600,fontSize:15,color:"var(--cream)",marginBottom:3}}>
                        {ex.name}
                        {ex.improved&&<span style={{marginLeft:8,fontFamily:"'DM Mono',monospace",fontSize:9,color:"var(--green2)",background:"rgba(74,124,89,0.15)",border:"1px solid rgba(74,124,89,0.3)",borderRadius:3,padding:"2px 5px",letterSpacing:1}}>PR ‚Üë</span>}
                      </div>
                      <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)"}}>
                        {ex.unit==="reps"?"Bodyweight":`${ex.weight} ${ex.unit}`} ¬∑ {ex.completedSets}/{ex.totalSets} sets
                      </div>
                      {ex.note&&<div style={{fontSize:12,color:"var(--cream2)",marginTop:5,fontStyle:"italic",opacity:0.8}}>"{ex.note}"</div>}
                    </div>
                    <div style={{fontFamily:"'DM Mono',monospace",fontSize:18,color:ex.completedSets===ex.totalSets?"var(--green2)":"var(--muted)",marginLeft:10}}>
                      {ex.completedSets===ex.totalSets?"‚úì":"~"}
                    </div>
                  </div>
                </div>
              ))}

              <button style={s.btn} onClick={()=>setScreen("home")}>Back to Home</button>
              <button style={{...s.btnOutline,width:"100%",marginTop:8,textAlign:"center"}} onClick={()=>setScreen("history")}>View History</button>
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ GOALS SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(screen==="goals") return(
        <div style={s.app}>
          {renderModal()}{Toast}
          <div style={{...s.content,...s.contentPt}}>
            <div style={s.header}>
              <div style={s.logo}>IRONFORM</div>
              <button style={s.btnSm} onClick={()=>setModal("addLiftGoal")}>+ New Goal</button>
            </div>

            <h2 style={{fontFamily:"'Playfair Display',serif",fontSize:26,color:"var(--cream)",marginBottom:4}}>Lift Goals</h2>
            <p style={{color:"var(--muted)",fontSize:13,marginBottom:20,fontFamily:"'DM Mono',monospace",letterSpacing:0.5,lineHeight:1.6}}>Set a target weight for any exercise. Click data points on the chart to see exact dates and weights.</p>

            {liftGoals.length===0?(
              <div style={{...s.card,textAlign:"center",padding:40}}>
                <div style={{fontSize:36,marginBottom:12}}>üéØ</div>
                <div style={{color:"var(--muted)",fontSize:14,marginBottom:18,fontFamily:"'DM Mono',monospace",letterSpacing:1}}>No goals set yet</div>
                <button style={s.btn} onClick={()=>setModal("addLiftGoal")}>Set Your First Goal</button>
              </div>
            ):liftGoals.map(goal=>{
              const def=allExercises.find(e=>e.id===goal.exId);
              if(!def) return null;
              const history=getLiftHistory(goal.exId);
              const current=history.length>0?history[history.length-1].weight:null;
              const pct=current?Math.min(100,Math.round((current/goal.targetWeight)*100)):0;
              const projDate=history.length>=2?projectGoalDate(history,goal.targetWeight):null;
              const achieved=current&&current>=goal.targetWeight;

              return(
                <div key={goal._id} style={{...s.card,marginBottom:12,padding:18}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:12}}>
                    <div>
                      <div style={{fontWeight:700,fontSize:17,color:"var(--cream)",marginBottom:2}}>{def.name}</div>
                      <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)"}}>
                        Target: <span style={{color:"var(--gold)"}}>{goal.targetWeight} {def.unit}</span>
                        {current&&<span> ¬∑ Current: <span style={{color:"var(--cream2)"}}>{current} {def.unit}</span></span>}
                      </div>
                    </div>
                    <button onClick={()=>doDelLiftGoal(goal._id)} style={{background:"none",border:"none",color:"var(--muted)",cursor:"pointer",fontSize:16,lineHeight:1,padding:"0 2px",flexShrink:0}}>√ó</button>
                  </div>

                  <div style={{marginBottom:12}}>
                    <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
                      <span style={{fontFamily:"'DM Mono',monospace",fontSize:9,color:"var(--muted)",letterSpacing:2,textTransform:"uppercase"}}>Progress</span>
                      <span style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:achieved?"var(--green2)":"var(--gold)"}}>{pct}%{achieved?" ‚Äî Achieved!":""}</span>
                    </div>
                    <div style={{height:6,background:"var(--surface2)",borderRadius:3,overflow:"hidden"}}>
                      <div style={{height:"100%",width:`${pct}%`,background:achieved?"var(--green2)":"var(--gold)",borderRadius:3,transition:"width 0.6s ease"}}/>
                    </div>
                  </div>

                  {/* ‚òÖ Interactive chart with clickable data points */}
                  {history.length>0?(
                    <div style={{background:"var(--surface2)",borderRadius:8,padding:"12px 8px 6px",marginBottom:10}}>
                      <MiniChart history={history} targetWeight={goal.targetWeight}/>
                    </div>
                  ):(
                    <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)",textAlign:"center",padding:"12px 0",letterSpacing:1}}>
                      Complete a workout with {def.name} to start tracking
                    </div>
                  )}

                  {projDate&&!achieved&&(
                    <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--cream2)",background:"rgba(200,146,42,0.08)",border:"1px solid rgba(200,146,42,0.2)",borderRadius:6,padding:"8px 12px",letterSpacing:0.5}}>
                      {projDate==="already achieved!"
                        ?"‚úì Already achieved based on your data"
                        :`Projected: ${projDate.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} (${Math.round((projDate-Date.now())/86400000)} days)`}
                    </div>
                  )}
                  {!projDate&&history.length>=1&&history.length<2&&(
                    <div style={{fontFamily:"'DM Mono',monospace",fontSize:10,color:"var(--muted)",letterSpacing:0.5,marginTop:4}}>
                      Projection available after 2+ sessions with this exercise
                    </div>
                  )}
                </div>
              );
            })}
          </div>
          <NavBar active="goals"/>
        </div>
      );

      // ‚îÄ‚îÄ HISTORY SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(screen==="history") return(
        <div style={s.app}>
          {renderModal()}{Toast}
          <div style={{...s.content,...s.contentPt}}>
            <div style={s.header}>
              <div style={s.logo}>IRONFORM</div>
              <button style={s.btnSm} onClick={()=>{setPastDate("");setPastRows([{exId:"",weight:"",reps:"",sets:""}]);setModal("logPastWorkout");}}>+ Log Past</button>
            </div>

            {/* Tab selector */}
            <div style={{display:"flex",gap:0,marginBottom:16,border:"1px solid var(--border)",borderRadius:8,overflow:"hidden"}}>
              {[["log","Workout Log"],["calendar","Calendar"]].map(([tab,lbl])=>(
                <button key={tab} onClick={()=>setHistoryTab(tab)} style={{flex:1,padding:"10px",fontFamily:"'DM Mono',monospace",fontSize:11,letterSpacing:2,textTransform:"uppercase",cursor:"pointer",border:"none",background:historyTab===tab?"rgba(200,146,42,0.18)":"var(--surface)",color:historyTab===tab?"var(--gold)":"var(--muted)"}}>
                  {lbl}
                </button>
              ))}
            </div>

            {/* Calendar tab */}
            {historyTab==="calendar"&&(
              <div style={s.card}>
                <CalendarView workouts={workouts}/>
              </div>
            )}

            {/* Log tab */}
            {historyTab==="log"&&(workouts.length===0?(
              <div style={{...s.card,textAlign:"center",padding:40}}>
                <div style={{fontSize:36,marginBottom:12}}>üìã</div>
                <div style={{color:"var(--muted)",marginBottom:20,fontFamily:"'DM Mono',monospace",fontSize:12,letterSpacing:1}}>No workouts yet</div>
                <button style={s.btn} onClick={()=>{setPastDate("");setPastRows([{exId:"",weight:"",reps:"",sets:""}]);setModal("logPastWorkout");}}>Import Past Workouts</button>
              </div>
            ):[...workouts].reverse().map(w=>{
              const wKey=w._id||w.date;
              const expanded=!!expandedWorkouts[wKey];
              return(
                <div key={wKey} style={s.card}>
                  {/* ‚òÖ Collapsible header */}
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer"}} onClick={()=>setExpandedWorkouts(p=>({...p,[wKey]:!p[wKey]}))}>
                    <div>
                      <div style={{fontWeight:700,fontSize:15,color:"var(--cream)"}}>{new Date(w.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"})}</div>
                      <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)",marginTop:2}}>{w.exercises?.length} exercises</div>
                    </div>
                    <div style={{display:"flex",gap:6,alignItems:"center"}}>
                      {w.templateLabel&&(()=>{const t=WORKOUT_TEMPLATES.find(x=>x.label===w.templateLabel);return<span style={{...s.tag,background:t?t.accentDim:"var(--surface2)",border:`1px solid ${t?t.accentBorder:"var(--border)"}`,color:t?t.accent:"var(--cream2)"}}>{w.templateLabel}</span>;})()}
                      {w.imported&&<span style={{...s.tag,background:"rgba(74,108,140,0.12)",border:"1px solid rgba(74,108,140,0.35)",color:"var(--blue2)"}}>Imported</span>}
                      <span style={{color:"var(--muted)",fontSize:18,lineHeight:1}}>{expanded?"‚ñ≤":"‚ñº"}</span>
                    </div>
                  </div>

                  {/* ‚òÖ Expanded exercise list ‚Äî clickable for notes, plus edit button */}
                  {expanded&&(
                    <div style={{marginTop:12}}>
                      {w.exercises?.map((ex,ei)=>{
                        const noteKey=`${wKey}_${ex.id}`;
                        const hasNote=ex.note&&ex.note.trim();
                        return(
                          <div key={ex.id||ei}>
                            <div
                              style={{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid var(--border)",fontSize:13,cursor:hasNote?"pointer":"default"}}
                              onClick={()=>hasNote&&setExpandedExNote(p=>({...p,[noteKey]:!p[noteKey]}))}
                            >
                              <span style={{color:"var(--cream2)",display:"flex",alignItems:"center",gap:6}}>
                                {ex.name}
                                {hasNote&&<span style={{fontSize:10,color:"var(--muted)"}}>üí¨</span>}
                              </span>
                              <span style={{fontFamily:"'DM Mono',monospace",fontSize:12,color:"var(--gold2)"}}>{ex.unit==="reps"?`BW √ó ${ex.reps}`:`${ex.weight}${ex.unit} √ó ${ex.reps}`}{ex.sets>1?` √ó ${ex.sets}s`:""}</span>
                            </div>
                            {expandedExNote[noteKey]&&hasNote&&(
                              <div style={{padding:"6px 10px",background:"rgba(200,146,42,0.06)",borderRadius:4,margin:"4px 0",fontStyle:"italic",fontSize:12,color:"var(--cream2)"}}>"{ex.note}"</div>
                            )}
                          </div>
                        );
                      })}
                      <div style={{display:"flex",justifyContent:"flex-end",marginTop:10}}>
                        <button style={s.btnSm} onClick={()=>{setEditingWorkout(w);setModal("editWorkout");}}>‚úè Edit</button>
                      </div>
                    </div>
                  )}
                </div>
              );
            }))}
          </div>
          <NavBar active="history"/>
        </div>
      );

      // ‚îÄ‚îÄ PROFILE SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(screen==="profile") return(
        <div style={s.app}>
          {renderModal()}{Toast}
          <div style={{...s.content,...s.contentPt}}>
            <div style={s.header}><div style={s.logo}>IRONFORM</div></div>

            <div style={{...s.cardWarm,marginBottom:14}}>
              <div style={{display:"flex",alignItems:"center",gap:14}}>
                {authUser.photoURL&&<img src={authUser.photoURL} alt="" style={{width:52,height:52,borderRadius:"50%",border:"2px solid var(--gold)",opacity:0.9}}/>}
                <div>
                  <div style={{fontFamily:"'Playfair Display',serif",fontSize:20,color:"var(--cream)"}}>{authUser.displayName||"Athlete"}</div>
                  <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)",marginTop:2}}>{authUser.email}</div>
                  <div style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)",marginTop:2}}>{workouts.length} sessions logged</div>
                </div>
              </div>
            </div>

            <div style={{...s.card,marginBottom:14}}>
              <span style={s.label}>Default Training Goal</span>
              <div style={{display:"flex",flexDirection:"column",gap:6,marginTop:6}}>
                {Object.entries(GOALS).map(([key,g])=>(
                  <button key={key} onClick={async()=>{await saveProfile({...profile,goal:key});showToast("Goal updated!");}}
                    style={{background:profile?.goal===key?"rgba(200,146,42,0.12)":"var(--surface2)",border:profile?.goal===key?"1px solid rgba(200,146,42,0.45)":"1px solid var(--border)",borderRadius:8,padding:"12px 14px",cursor:"pointer",color:profile?.goal===key?"var(--gold)":"var(--muted)",textAlign:"left",fontSize:14,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                    <div><div style={{fontWeight:600,color:profile?.goal===key?"var(--cream)":"var(--cream2)"}}>{g.label}</div><div style={{fontFamily:"'DM Mono',monospace",fontSize:10,marginTop:2,letterSpacing:0.5,opacity:0.7}}>{g.description}</div></div>
                    {profile?.goal===key&&<span style={{color:"var(--green2)"}}>‚úì</span>}
                  </button>
                ))}
              </div>
            </div>

            <div style={{...s.card,marginBottom:14}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
                <span style={s.label}>Custom Exercises ({customExs.length})</span>
                <button style={s.btnSm} onClick={()=>{setNewEx({name:"",category:"Chest",unit:"lbs",defaultWeight:45,increment:5});setModal("addExercise");}}>+ New</button>
              </div>
              {customExs.length===0?<p style={{fontFamily:"'DM Mono',monospace",color:"var(--muted)",fontSize:12,letterSpacing:0.5}}>None yet.</p>:customExs.map(ex=>(
                <div key={ex._fid||ex.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:"1px solid var(--border)"}}>
                  <div><span style={{fontSize:14,color:"var(--cream)"}}>{ex.name}</span><div style={{fontFamily:"'DM Mono',monospace",fontSize:10,color:"var(--muted)",marginTop:2}}>{ex.category} ¬∑ {ex.unit==="reps"?"bodyweight":`${ex.defaultWeight}${ex.unit}`}</div></div>
                </div>
              ))}
            </div>

            <button style={{...s.btnDanger,width:"100%",marginTop:6}} onClick={handleSignOut}>Sign Out</button>
          </div>
          <NavBar active="profile"/>
        </div>
      );

      // ‚îÄ‚îÄ HOME SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const tiles=[
        ...WORKOUT_TEMPLATES.map(tmpl=>{
          const last=[...workouts].reverse().find(w=>w.templateLabel===tmpl.label);
          const days=last?Math.floor((Date.now()-new Date(last.date))/86400000):null;
          return{id:tmpl.id,emoji:tmpl.emoji,label:tmpl.label,sub:days!==null?(days===0?"Today":`${days}d ago`):"Never done",
            accent:tmpl.accent,accentDim:tmpl.accentDim,accentBorder:tmpl.accentBorder,
            onClick:()=>{setActiveTmpl(tmpl);setExtraExIds([]);setRemovedExIds([]);const sr=GOAL_SETS[profile?.goal||"hypertrophy"];setPreviewSets(sr.sets);setPreviewReps(sr.reps);setRepScheme("standard");setScreen("preset_preview");}};
        }),
        {id:"custom",emoji:"‚ö°",label:"Custom",sub:"Build your own",
          accent:"#4a6c8c",accentDim:"rgba(74,108,140,0.15)",accentBorder:"rgba(74,108,140,0.45)",
          onClick:()=>{setCustomExIds([]);setCustomGoal("hypertrophy");setScreen("custom_builder");}},
      ];

      const lastWorkout=workouts[workouts.length-1];
      const daysSinceLast=lastWorkout?Math.floor((Date.now()-new Date(lastWorkout.date))/86400000):null;
      const streak=(()=>{if(!workouts.length)return 0;let s=0;const dates=new Set(workouts.map(w=>new Date(w.date).toDateString()));const d=new Date();d.setHours(0,0,0,0);while(dates.has(d.toDateString())){s++;d.setDate(d.getDate()-1);}return s;})();

      return(
        <div style={s.app}>
          {renderModal()}{Toast}
          <div style={{...s.content,...s.contentPt}}>
            <div style={s.header}>
              <div style={s.logo}>IRONFORM</div>
              {authUser.photoURL&&<img src={authUser.photoURL} alt="" style={{width:30,height:30,borderRadius:"50%",border:"1px solid var(--border2)",cursor:"pointer",opacity:0.85}} onClick={()=>setScreen("profile")}/>}
            </div>

            {/* Stats row */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:20}}>
              {[{label:"Sessions",value:workouts.length},{label:"Days Rest",value:daysSinceLast===null?"‚Äî":daysSinceLast},{label:"Streak",value:streak}].map(stat=>(
                <div key={stat.label} style={{...s.card,padding:14,textAlign:"center",marginBottom:0}}>
                  <div style={{fontFamily:"'Playfair Display',serif",fontSize:24,color:"var(--gold)",lineHeight:1}}>{stat.value}</div>
                  <span style={{...s.label,marginBottom:0,marginTop:4,fontSize:8}}>{stat.label}</span>
                </div>
              ))}
            </div>

            <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:14}}>
              <div style={{flex:1,height:1,background:"var(--border)"}}/>
              <span style={{fontFamily:"'DM Mono',monospace",fontSize:9,letterSpacing:3,color:"var(--muted)",textTransform:"uppercase"}}>Begin Session</span>
              <div style={{flex:1,height:1,background:"var(--border)"}}/>
            </div>

            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:16}}>
              {tiles.map(tile=>(
                <button key={tile.id} onClick={tile.onClick} style={{background:tile.accentDim,border:`1px solid ${tile.accentBorder}`,borderRadius:12,padding:"22px 14px",cursor:"pointer",textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center",gap:7,width:"100%"}}>
                  <span style={{fontSize:30}}>{tile.emoji}</span>
                  <span style={{fontFamily:"'Playfair Display',serif",fontWeight:700,fontSize:14,color:tile.accent,lineHeight:1.2}}>{tile.label}</span>
                  <span style={{fontFamily:"'DM Mono',monospace",fontSize:9,color:"var(--muted)",letterSpacing:1,textTransform:"uppercase"}}>{tile.sub}</span>
                </button>
              ))}
            </div>

            <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:14}}>
              <div style={{flex:1,height:1,background:"var(--border)"}}/>
              <span style={{fontFamily:"'DM Mono',monospace",fontSize:9,letterSpacing:3,color:"var(--muted)",textTransform:"uppercase"}}>Quick Actions</span>
              <div style={{flex:1,height:1,background:"var(--border)"}}/>
            </div>

            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:14}}>
              <button style={{...s.card,marginBottom:0,cursor:"pointer",textAlign:"center",padding:14,border:"1px solid var(--border)",background:"var(--surface)"}}
                onClick={()=>{setPastDate("");setPastRows([{exId:"",weight:"",reps:"",sets:""}]);setModal("logPastWorkout");}}>
                <div style={{fontSize:18,marginBottom:4}}>üì•</div>
                <div style={{fontFamily:"'DM Mono',monospace",fontSize:9,color:"var(--muted)",letterSpacing:2,textTransform:"uppercase"}}>Log Past</div>
              </button>
              <button style={{...s.card,marginBottom:0,cursor:"pointer",textAlign:"center",padding:14,border:"1px solid var(--border)",background:"var(--surface)"}}
                onClick={()=>{setNewEx({name:"",category:"Chest",unit:"lbs",defaultWeight:45,increment:5});setModal("addExercise");}}>
                <div style={{fontSize:18,marginBottom:4}}>‚ûï</div>
                <div style={{fontFamily:"'DM Mono',monospace",fontSize:9,color:"var(--muted)",letterSpacing:2,textTransform:"uppercase"}}>New Lift</div>
              </button>
            </div>

            {lastWorkout&&(
              <div style={s.card}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
                  <span style={s.label}>Last Session</span>
                  <span style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:"var(--muted)"}}>{new Date(lastWorkout.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})}</span>
                </div>
                {lastWorkout.exercises?.slice(0,4).map(ex=>(
                  <div key={ex.id} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid var(--border)",fontSize:13}}>
                    <span style={{color:"var(--cream2)"}}>{ex.name}</span>
                    <span style={{fontFamily:"'DM Mono',monospace",fontSize:12,color:"var(--gold2)"}}>{ex.unit==="reps"?`BW √ó ${ex.reps}`:`${ex.weight}${ex.unit} √ó ${ex.reps}`}</span>
                  </div>
                ))}
              </div>
            )}

            {/* ‚òÖ Version badge */}
            <div style={{textAlign:"center",marginTop:16}}>
              <button onClick={()=>setModal("versionHistory")} style={{background:"none",border:"none",cursor:"pointer",fontFamily:"'DM Mono',monospace",fontSize:9,letterSpacing:2,color:"var(--muted)",textTransform:"uppercase",opacity:0.6}}>
                v{APP_VERSION}
              </button>
            </div>
          </div>
          <NavBar active="home"/>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
