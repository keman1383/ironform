<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>IRONFORM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    body { background: #0a0a0f; color: #f0f0e8; font-family: 'DM Sans', sans-serif; -webkit-font-smoothing: antialiased; }
    input, select, button, textarea { font-family: inherit; }
    select option { background: #1a1a2e; color: #f0f0e8; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(232,255,107,0.2); border-radius: 2px; }
    * { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ‚îÄ‚îÄ FIREBASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const FIREBASE_CONFIG = {
      apiKey:            "AIzaSyCQDJhJFUCuTQrymlmOx3Sgv54UUrMPekY",
      authDomain:        "trainerdata-c5e64.firebaseapp.com",
      projectId:         "trainerdata-c5e64",
      storageBucket:     "trainerdata-c5e64.firebasestorage.app",
      messagingSenderId: "71847069277",
      appId:             "1:71847069277:web:2dde9bfd125c5d6c466fb4",

    };

    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const gProvider = new firebase.auth.GoogleAuthProvider();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    const fbGetProfile   = async (uid) => { const d = await db.collection("users").doc(uid).get(); return d.exists ? d.data() : null; };
    const fbSetProfile   = async (uid, data) => db.collection("users").doc(uid).set(data, {merge:true});
    const fbGetWorkouts  = async (uid) => { const s = await db.collection("users").doc(uid).collection("workouts").orderBy("date").get(); return s.docs.map(d=>({...d.data(),_id:d.id})); };
    const fbAddWorkout   = async (uid, w) => { const r = await db.collection("users").doc(uid).collection("workouts").add(w); return r.id; };
    const fbGetCustomExs = async (uid) => { const s = await db.collection("users").doc(uid).collection("customExercises").get(); return s.docs.map(d=>({...d.data(),_fid:d.id})); };
    const fbAddCustomEx  = async (uid, ex) => { const r = await db.collection("users").doc(uid).collection("customExercises").add(ex); return r.id; };

    // ‚îÄ‚îÄ EXERCISES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const BUILTIN_EXERCISES = [
      {id:"bench",            name:"Bench Press",                      category:"Chest",     unit:"lbs", defaultWeight:115,    increment:5},
      {id:"decline_press",    name:"Decline Press",                    category:"Chest",     unit:"lbs", defaultWeight:65,     increment:5},
      {id:"incline_db_press", name:"Incline Dumbbell Press",           category:"Chest",     unit:"lbs", defaultWeight:30,     increment:2.5},
      {id:"chest_fly",        name:"Chest Fly Machine",                category:"Chest",     unit:"lbs", defaultWeight:55,     increment:5},
      {id:"cable_fly",        name:"Cable Fly",                        category:"Chest",     unit:"lbs", defaultWeight:22.5,   increment:2.5},
      {id:"assisted_dip",     name:"Assisted Dip",                     category:"Chest",     unit:"lbs", defaultWeight:118.75, increment:2.5},
      {id:"lat_pulldown",     name:"Lat Pull Down",                    category:"Back",      unit:"lbs", defaultWeight:105,    increment:5},
      {id:"row",              name:"Row",                              category:"Back",      unit:"lbs", defaultWeight:85,     increment:5},
      {id:"seated_cable_row", name:"Seated Cable Row",                 category:"Back",      unit:"lbs", defaultWeight:85,     increment:5},
      {id:"single_arm_row",   name:"Single Arm Cable Row",             category:"Back",      unit:"lbs", defaultWeight:45,     increment:2.5},
      {id:"high_row",         name:"High Row Machine",                 category:"Back",      unit:"lbs", defaultWeight:60,     increment:5},
      {id:"rdl",              name:"Romanian Deadlifts",               category:"Back",      unit:"lbs", defaultWeight:95,     increment:5},
      {id:"face_pull",        name:"Face Pulls",                       category:"Back",      unit:"lbs", defaultWeight:22.5,   increment:2.5},
      {id:"squat",            name:"Squat",                            category:"Legs",      unit:"lbs", defaultWeight:115,    increment:5},
      {id:"leg_press",        name:"Leg Press",                        category:"Legs",      unit:"lbs", defaultWeight:220,    increment:10},
      {id:"leg_curl",         name:"Leg Curl",                         category:"Legs",      unit:"lbs", defaultWeight:105,    increment:5},
      {id:"calf_raise",       name:"Calf Raise",                       category:"Legs",      unit:"lbs", defaultWeight:50,     increment:5},
      {id:"hip_adduction",    name:"Hip Adduction Machine",            category:"Legs",      unit:"lbs", defaultWeight:130,    increment:5},
      {id:"glute_drive",      name:"Glute Drive",                      category:"Legs",      unit:"lbs", defaultWeight:95,     increment:5},
      {id:"oh_db_press",      name:"Overhead Dumbbell Shoulder Press", category:"Shoulders", unit:"lbs", defaultWeight:10,     increment:2.5},
      {id:"lateral_raise",    name:"Dumbbell Lateral Raises",          category:"Shoulders", unit:"lbs", defaultWeight:10,     increment:2.5},
      {id:"shrugs",           name:"Shoulder Shrugs",                  category:"Shoulders", unit:"lbs", defaultWeight:17.5,   increment:2.5},
      {id:"press_machine",    name:"Press Machine",                    category:"Shoulders", unit:"lbs", defaultWeight:20,     increment:5},
      {id:"cable_curl",       name:"Cable Curl",                       category:"Arms",      unit:"lbs", defaultWeight:22.5,   increment:2.5},
      {id:"one_arm_curl",     name:"One Arm Cable Curl",               category:"Arms",      unit:"lbs", defaultWeight:32.5,   increment:2.5},
      {id:"hammer_curl",      name:"Hammer Curl",                      category:"Arms",      unit:"lbs", defaultWeight:12.5,   increment:2.5},
      {id:"rope_hammer_curl", name:"Rope Hammer Curl",                 category:"Arms",      unit:"lbs", defaultWeight:22.5,   increment:2.5},
      {id:"db_bicep_curl",    name:"Seated Dumbbell Bicep Curls",      category:"Arms",      unit:"lbs", defaultWeight:15,     increment:2.5},
      {id:"preacher_curl",    name:"Preacher Curl Machine",            category:"Arms",      unit:"lbs", defaultWeight:10,     increment:2.5},
      {id:"tricep_pushdown",  name:"Tricep Push Down",                 category:"Arms",      unit:"lbs", defaultWeight:32.5,   increment:2.5},
      {id:"tricep_rope",      name:"Tricep Rope Push Down",            category:"Arms",      unit:"lbs", defaultWeight:27.5,   increment:2.5},
      {id:"one_arm_tricep",   name:"One Arm Cable Tricep",             category:"Arms",      unit:"lbs", defaultWeight:12.5,   increment:2.5},
      {id:"cable_ab_twist",   name:"Cable Ab Twist",                   category:"Core",      unit:"lbs", defaultWeight:12.5,   increment:2.5},
      {id:"hanging_leg_lift", name:"Hanging Leg Lifts",                category:"Core",      unit:"reps",defaultWeight:0,      increment:1},
    ];

    const CATEGORIES = ["Chest","Back","Legs","Shoulders","Arms","Core","Cardio","Other"];

    const GOALS = {
      strength:    {label:"Strength",     increment:1.05,  description:"Heavier weight, lower reps"},
      hypertrophy: {label:"Muscle Growth",increment:1.025, description:"Moderate weight, higher reps"},
      endurance:   {label:"Endurance",    increment:1.015, description:"Lighter weight, high reps"},
      maintain:    {label:"Maintain",     increment:1.0,   description:"Keep current level"},
    };
    const GOAL_SETS = {
      strength:    {sets:5, reps:5},
      hypertrophy: {sets:4, reps:10},
      endurance:   {sets:3, reps:15},
      maintain:    {sets:3, reps:8},
    };

    const WORKOUT_TEMPLATES = [
      {id:"push", label:"Push Day", emoji:"üí™", color:"#e8ff6b", colorBg:"rgba(232,255,107,0.08)", colorBorder:"rgba(232,255,107,0.35)",
        exercises:["bench","incline_db_press","cable_fly","lateral_raise","oh_db_press","tricep_rope","assisted_dip"]},
      {id:"pull", label:"Pull Day", emoji:"üèãÔ∏è", color:"#7ec8ff", colorBg:"rgba(126,200,255,0.08)", colorBorder:"rgba(126,200,255,0.35)",
        exercises:["lat_pulldown","seated_cable_row","single_arm_row","preacher_curl","rope_hammer_curl"]},
      {id:"legs", label:"Leg Day",  emoji:"ü¶µ", color:"#ff9f6b", colorBg:"rgba(255,159,107,0.08)", colorBorder:"rgba(255,159,107,0.35)",
        exercises:["squat","rdl","leg_press","calf_raise","glute_drive","hip_adduction","leg_curl"]},
    ];

    function safeProgressWeight(current, goal, weeksSince, unit) {
      if (goal==="maintain") return current;
      const factor = Math.pow(GOALS[goal].increment, weeksSince||1);
      const proposed = Math.round((current*factor)/2.5)*2.5;
      const maxInc = ({lbs:10,reps:2}[unit]||5)*(weeksSince||1);
      return Math.min(proposed, current+maxInc);
    }

    // ‚îÄ‚îÄ SHARED UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function Modal({children, onClose}) {
      return (
        <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:500,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
          <div onClick={e=>e.stopPropagation()} style={{background:"#111118",border:"1px solid rgba(232,255,107,0.15)",borderRadius:"20px 20px 0 0",width:"100%",maxWidth:480,maxHeight:"90vh",overflowY:"auto",padding:24,paddingBottom:40}}>
            {children}
          </div>
        </div>
      );
    }

    function BackBtn({onClick, label="Home"}) {
      return (
        <button onClick={onClick} style={{background:"none",border:"none",color:"#666",cursor:"pointer",display:"flex",alignItems:"center",gap:6,fontFamily:"'Space Mono',monospace",fontSize:11,letterSpacing:1,padding:"0 0 20px 0"}}>
          ‚Üê {label.toUpperCase()}
        </button>
      );
    }

    function Stepper({value, onChange, min=1, label}) {
      return (
        <div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:6}}>
          <span style={{fontSize:9,letterSpacing:2,color:"#888",fontFamily:"'Space Mono',monospace"}}>{label}</span>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <button onClick={()=>onChange(Math.max(min, value-1))} style={{width:32,height:32,borderRadius:8,border:"1px solid rgba(232,255,107,0.2)",background:"transparent",color:"#e8ff6b",fontSize:18,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>‚àí</button>
            <span style={{fontFamily:"'Space Mono',monospace",fontSize:20,fontWeight:700,color:"#f0f0e8",minWidth:28,textAlign:"center"}}>{value}</span>
            <button onClick={()=>onChange(value+1)} style={{width:32,height:32,borderRadius:8,border:"1px solid rgba(232,255,107,0.2)",background:"transparent",color:"#e8ff6b",fontSize:18,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>+</button>
          </div>
        </div>
      );
    }

    // ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function App() {
      const [authUser,      setAuthUser]      = useState(undefined);
      const [screen,        setScreen]        = useState("home");
      const [profile,       setProfileS]      = useState(null);
      const [workouts,      setWorkouts]      = useState([]);
      const [customExs,     setCustomExs]     = useState([]);
      const [dataLoading,   setDataLoading]   = useState(false);

      // Workout state
      const [activeTmpl,    setActiveTmpl]    = useState(null);
      const [extraExIds,    setExtraExIds]    = useState([]);
      const [previewSets,   setPreviewSets]   = useState(4);
      const [previewReps,   setPreviewReps]   = useState(10);
      const [activeWorkout, setActiveWorkout] = useState(null);
      const [currentExIdx,  setCurrentExIdx]  = useState(0);  // one-at-a-time index
      const [completedSets, setCompletedSets] = useState({});
      const [noteFor,       setNoteFor]       = useState({});

      // Custom builder
      const [customExIds,   setCustomExIds]   = useState([]);
      const [customGoal,    setCustomGoal]    = useState("hypertrophy");

      // Modals & forms
      const [modal,         setModal]         = useState(null);
      const [newEx,         setNewEx]         = useState({name:"",category:"Chest",unit:"lbs",defaultWeight:45,increment:5});
      const [pastDate,      setPastDate]      = useState("");
      const [pastRows,      setPastRows]      = useState([{exId:"",weight:"",reps:"",sets:""}]);
      const [signInErr,     setSignInErr]     = useState(null);
      const [signingIn,     setSigningIn]     = useState(false);
      const [toast,         setToast]         = useState(null);
      const toastTimer = useRef(null);

      const allExercises = [...BUILTIN_EXERCISES, ...customExs];

      // ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(async user => {
          setAuthUser(user||null);
          if (user) loadData(user.uid);
        });
        return ()=>unsub();
      }, []);

      const loadData = async (uid) => {
        setDataLoading(true);
        try {
          const [prof,wkts,cexs] = await Promise.all([fbGetProfile(uid),fbGetWorkouts(uid),fbGetCustomExs(uid)]);
          if (prof) setProfileS(prof);
          setWorkouts(wkts);
          setCustomExs(cexs);
        } catch(e) { console.error(e); }
        setDataLoading(false);
      };

      useEffect(() => {
        if (authUser && !dataLoading && profile===null) {
          const p={goal:"hypertrophy",exercises:[],created:new Date().toISOString(),uid:authUser.uid};
          saveProfile(p);
        }
      }, [authUser,dataLoading,profile]);

      const handleSignIn = async () => {
        setSignInErr(null); setSigningIn(true);
        try { await auth.signInWithPopup(gProvider); }
        catch(e) {
          setSigningIn(false);
          if (e.code!=="auth/popup-closed-by-user"&&e.code!=="auth/cancelled-popup-request")
            setSignInErr("Sign-in failed: "+(e.message||e.code));
        }
      };

      const handleSignOut = async () => { await auth.signOut(); setProfileS(null);setWorkouts([]);setCustomExs([]);setScreen("home"); };

      const showToast = (msg) => { setToast(msg); clearTimeout(toastTimer.current); toastTimer.current=setTimeout(()=>setToast(null),3000); };

      const saveProfile  = async (p) => { setProfileS(p); if(authUser) await fbSetProfile(authUser.uid,p); };
      const addWorkout   = async (w) => { if(authUser){const id=await fbAddWorkout(authUser.uid,w);w={...w,_id:id};} setWorkouts(prev=>[...prev,w].sort((a,b)=>new Date(a.date)-new Date(b.date))); };
      const doAddCustomEx = async (ex) => { if(authUser){const fid=await fbAddCustomEx(authUser.uid,ex);ex={...ex,_fid:fid};} setCustomExs(prev=>[...prev,ex]); return ex; };

      // ‚îÄ‚îÄ WORKOUT LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const getLastForExercise = (exId) => {
        for(let i=workouts.length-1;i>=0;i--){
          const ex=workouts[i].exercises?.find(e=>e.id===exId);
          if(ex) return {workout:workouts[i],exercise:ex};
        }
        return null;
      };

      const buildExerciseList = (exIdList, sets, reps) => {
        return exIdList.map(exId=>{
          const def=allExercises.find(e=>e.id===exId);
          if(!def) return null;
          const last=getLastForExercise(exId);
          const goal=profile?.goal||"hypertrophy";
          let weight=def.defaultWeight;
          if(last){
            const days=(Date.now()-new Date(last.workout.date))/86400000;
            const weeks=Math.max(1,Math.round(days/7));
            weight=safeProgressWeight(last.exercise.weight,goal,weeks,def.unit);
          }
          return {id:exId,name:def.name,category:def.category,weight,unit:def.unit,sets,reps,increment:def.increment};
        }).filter(Boolean);
      };

      const launchWorkout = (tmpl, extras, sets, reps) => {
        const exercises=buildExerciseList([...tmpl.exercises,...extras],sets,reps);
        setActiveWorkout({date:new Date().toISOString(),exercises,completed:false,templateLabel:tmpl.label});
        setCurrentExIdx(0); setCompletedSets({}); setNoteFor({});
        setScreen("workout");
      };

      const launchCustomWorkout = () => {
        const sr=GOAL_SETS[customGoal];
        const exercises=buildExerciseList(customExIds,sr.sets,sr.reps);
        setActiveWorkout({date:new Date().toISOString(),exercises,completed:false,templateLabel:"Custom"});
        setCurrentExIdx(0); setCompletedSets({}); setNoteFor({});
        setScreen("workout");
      };

      const finishWorkout = async () => {
        await addWorkout({...activeWorkout,completed:true});
        setActiveWorkout(null); setActiveTmpl(null); setExtraExIds([]);
        showToast("Workout saved! Great work üí™");
        setScreen("home");
      };

      const cancelWorkout = () => { setActiveWorkout(null);setActiveTmpl(null);setExtraExIds([]);setScreen("home"); };

      // Set completion helpers
      const toggleSet = (exId,i) => setCompletedSets(p=>({...p,[`${exId}_${i}`]:!p[`${exId}_${i}`]}));
      const adjustWeight = (exId,delta) => setActiveWorkout(p=>({...p,exercises:p.exercises.map(e=>e.id===exId?{...e,weight:Math.max(0,+(e.weight+delta).toFixed(2))}:e)}));

      const setsForEx = (ex) => Array.from({length:ex.sets},(_,i)=>!!completedSets[`${ex.id}_${i}`]);
      const totalSets = activeWorkout?activeWorkout.exercises.reduce((a,e)=>a+e.sets,0):0;
      const totalDone = activeWorkout?activeWorkout.exercises.reduce((a,ex)=>{
        setsForEx(ex).forEach(d=>{if(d)a++;});return a;
      },0):0;

      // Save custom exercise
      const saveNewExercise = async (addToWorkout=false) => {
        if(!newEx.name.trim()) return;
        const ex={id:"custom_"+Date.now(),name:newEx.name.trim(),category:newEx.category,unit:newEx.unit,defaultWeight:Number(newEx.defaultWeight)||0,increment:Number(newEx.increment)||5,custom:true};
        const saved=await doAddCustomEx(ex);
        if(addToWorkout){
          if(activeTmpl) setExtraExIds(p=>[...p,saved.id]);
          else setCustomExIds(p=>[...p,saved.id]);
        }
        setNewEx({name:"",category:"Chest",unit:"lbs",defaultWeight:45,increment:5});
        setModal(null); showToast(ex.name+" added!");
      };

      // Save past workout
      const savePastWorkout = async () => {
        if(!pastDate) return;
        const exercises=pastRows.filter(r=>r.exId&&r.weight!==""&&r.reps!=="").map(r=>{
          const def=allExercises.find(e=>e.id===r.exId);
          return {id:r.exId,name:def?.name||r.exId,category:def?.category||"Other",weight:Number(r.weight),unit:def?.unit||"lbs",sets:Number(r.sets)||3,reps:Number(r.reps),increment:def?.increment||5};
        });
        if(!exercises.length) return;
        await addWorkout({date:new Date(pastDate+"T12:00:00").toISOString(),exercises,completed:true,imported:true});
        setPastDate(""); setPastRows([{exId:"",weight:"",reps:"",sets:""}]);
        setModal(null); showToast("Past workout imported!");
      };

      // ‚îÄ‚îÄ STYLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const s = {
        app:       {minHeight:"100vh",background:"#0a0a0f",color:"#f0f0e8",fontFamily:"'DM Sans',sans-serif",position:"relative"},
        bg:        {position:"fixed",inset:0,background:"radial-gradient(ellipse 80% 60% at 50% -20%, #1a1a2e 0%, #0a0a0f 60%)",zIndex:0,pointerEvents:"none"},
        grid:      {position:"fixed",inset:0,backgroundImage:"linear-gradient(rgba(232,255,107,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(232,255,107,0.03) 1px,transparent 1px)",backgroundSize:"60px 60px",zIndex:0,pointerEvents:"none"},
        content:   {position:"relative",zIndex:1,maxWidth:480,margin:"0 auto",padding:"24px 20px 110px"},
        header:    {display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:24,paddingTop:8},
        logo:      {fontFamily:"'Space Mono',monospace",fontSize:20,fontWeight:700,color:"#e8ff6b",letterSpacing:2},
        card:      {background:"rgba(255,255,255,0.04)",border:"1px solid rgba(232,255,107,0.12)",borderRadius:16,padding:20,marginBottom:12},
        accentCard:{background:"rgba(232,255,107,0.08)",border:"1px solid rgba(232,255,107,0.3)",borderRadius:16,padding:24,marginBottom:16},
        btn:       {background:"#e8ff6b",color:"#0a0a0f",border:"none",borderRadius:12,padding:"14px 28px",fontFamily:"'Space Mono',monospace",fontWeight:700,fontSize:14,letterSpacing:1,cursor:"pointer",width:"100%",marginTop:8,display:"block"},
        btnOutline:{background:"transparent",color:"#e8ff6b",border:"1px solid rgba(232,255,107,0.4)",borderRadius:12,padding:"12px 24px",fontFamily:"'Space Mono',monospace",fontSize:13,letterSpacing:1,cursor:"pointer"},
        btnSm:     {background:"rgba(232,255,107,0.12)",color:"#e8ff6b",border:"1px solid rgba(232,255,107,0.3)",borderRadius:8,padding:"8px 14px",fontFamily:"'Space Mono',monospace",fontSize:11,letterSpacing:1,cursor:"pointer"},
        btnDanger: {background:"rgba(255,80,80,0.1)",color:"#ff6b6b",border:"1px solid rgba(255,80,80,0.3)",borderRadius:12,padding:"10px 20px",fontFamily:"'Space Mono',monospace",fontSize:12,cursor:"pointer"},
        label:     {fontSize:11,letterSpacing:3,color:"#888",fontFamily:"'Space Mono',monospace",marginBottom:8,textTransform:"uppercase",display:"block"},
        input:     {background:"rgba(255,255,255,0.06)",border:"1px solid rgba(232,255,107,0.2)",borderRadius:10,padding:"12px 16px",color:"#f0f0e8",fontFamily:"'DM Sans',sans-serif",fontSize:16,width:"100%",outline:"none",boxSizing:"border-box"},
        select:    {background:"rgba(30,30,48,1)",border:"1px solid rgba(232,255,107,0.2)",borderRadius:10,padding:"12px 16px",color:"#f0f0e8",fontFamily:"'DM Sans',sans-serif",fontSize:15,width:"100%",outline:"none",boxSizing:"border-box"},
        tag:       {display:"inline-block",background:"rgba(232,255,107,0.1)",border:"1px solid rgba(232,255,107,0.25)",borderRadius:6,padding:"4px 10px",fontSize:11,letterSpacing:1,color:"#e8ff6b",fontFamily:"'Space Mono',monospace"},
        navBar:    {position:"fixed",bottom:0,left:0,right:0,background:"rgba(10,10,15,0.97)",borderTop:"1px solid rgba(232,255,107,0.1)",display:"flex",justifyContent:"space-around",padding:"12px 0 20px",zIndex:100},
        navBtn:    {background:"none",border:"none",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:4,fontFamily:"'Space Mono',monospace",fontSize:9,letterSpacing:1,padding:"4px 20px"},
        setBtn:    {width:44,height:44,borderRadius:10,border:"1px solid rgba(232,255,107,0.25)",background:"transparent",color:"#e8ff6b",fontSize:22,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},
        setDot:    (done)=>({width:44,height:44,borderRadius:10,border:done?"none":"1px solid rgba(255,255,255,0.15)",background:done?"#e8ff6b":"rgba(255,255,255,0.04)",color:done?"#0a0a0f":"#555",fontFamily:"'Space Mono',monospace",fontSize:13,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.15s",fontWeight:700}),
      };

      const Toast = toast ? <div style={{position:"fixed",top:24,left:"50%",transform:"translateX(-50%)",background:"#e8ff6b",color:"#0a0a0f",padding:"12px 24px",borderRadius:10,fontFamily:"'Space Mono',monospace",fontSize:13,fontWeight:700,zIndex:600,boxShadow:"0 8px 32px rgba(232,255,107,0.3)",whiteSpace:"nowrap"}}>{toast}</div> : null;

      const NavBar = ({active}) => (
        <nav style={s.navBar}>
          {[["üè†","HOME","home"],["üìã","HISTORY","history"],["‚öôÔ∏è","PROFILE","profile"]].map(([icon,lbl,scr])=>(
            <button key={scr} style={{...s.navBtn,color:active===scr?"#e8ff6b":"#555"}} onClick={()=>setScreen(scr)}>
              <span style={{fontSize:22}}>{icon}</span>{lbl}
            </button>
          ))}
        </nav>
      );

      // ‚îÄ‚îÄ EXERCISE FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const ExerciseFormFields = () => (
        <div style={{display:"flex",flexDirection:"column",gap:12}}>
          <div><span style={s.label}>Name</span><input style={s.input} placeholder="e.g. Cable Fly" value={newEx.name} onChange={e=>setNewEx(p=>({...p,name:e.target.value}))} /></div>
          <div><span style={s.label}>Category</span><select style={s.select} value={newEx.category} onChange={e=>setNewEx(p=>({...p,category:e.target.value}))}>{CATEGORIES.map(c=><option key={c}>{c}</option>)}</select></div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <div><span style={s.label}>Unit</span><select style={s.select} value={newEx.unit} onChange={e=>setNewEx(p=>({...p,unit:e.target.value}))}><option value="lbs">lbs</option><option value="kg">kg</option><option value="reps">Bodyweight</option></select></div>
            <div><span style={s.label}>Starting Weight</span><input style={s.input} type="number" value={newEx.defaultWeight} onChange={e=>setNewEx(p=>({...p,defaultWeight:e.target.value}))} disabled={newEx.unit==="reps"} /></div>
          </div>
          <div><span style={s.label}>Increment Per Session</span><input style={s.input} type="number" value={newEx.increment} onChange={e=>setNewEx(p=>({...p,increment:e.target.value}))} /></div>
        </div>
      );

      // ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // NOTE: renderModal is always rendered at the top level of every screen
      // so modals work regardless of which screen is active
      const renderModal = () => {
        if (modal==="browseAdd") {
          const activeIds = activeTmpl ? [...activeTmpl.exercises,...extraExIds] : customExIds;
          const available = allExercises.filter(ex=>!activeIds.includes(ex.id));
          return (
            <Modal onClose={()=>setModal(null)}>
              <span style={{...s.label,fontSize:13,marginBottom:16}}>ADD EXERCISE</span>
              <div style={{maxHeight:"55vh",overflowY:"auto",marginBottom:12}}>
                {CATEGORIES.map(cat=>{
                  const ces=available.filter(e=>e.category===cat);
                  if(!ces.length) return null;
                  return (
                    <div key={cat} style={{marginBottom:14}}>
                      <span style={{...s.label,fontSize:9}}>{cat}</span>
                      <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                        {ces.map(ex=>(
                          <button key={ex.id} onClick={()=>{
                            if(activeTmpl) setExtraExIds(p=>[...p,ex.id]);
                            else setCustomExIds(p=>[...p,ex.id]);
                            setModal(null); showToast(ex.name+" added!");
                          }} style={{background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:8,padding:"7px 12px",color:"#ccc",fontSize:13,cursor:"pointer"}}>
                            {ex.name}{ex.custom?" ‚òÖ":""}
                          </button>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
              <button style={{...s.btnOutline,width:"100%",fontSize:12}} onClick={()=>setModal("createAndAdd")}>+ Create New Exercise</button>
            </Modal>
          );
        }
        if (modal==="createAndAdd") return (
          <Modal onClose={()=>setModal(null)}>
            <span style={{...s.label,fontSize:13,marginBottom:16}}>CREATE & ADD EXERCISE</span>
            <ExerciseFormFields />
            <button style={{...s.btn,marginTop:12}} onClick={()=>saveNewExercise(true)}>CREATE & ADD</button>
          </Modal>
        );
        if (modal==="addExercise") return (
          <Modal onClose={()=>setModal(null)}>
            <span style={{...s.label,fontSize:13,marginBottom:16}}>ADD CUSTOM EXERCISE</span>
            <ExerciseFormFields />
            <button style={{...s.btn,marginTop:12}} onClick={()=>saveNewExercise(false)}>ADD EXERCISE</button>
          </Modal>
        );
        if (modal==="logPastWorkout") return (
          <Modal onClose={()=>setModal(null)}>
            <span style={{...s.label,fontSize:13,marginBottom:4}}>LOG PAST WORKOUT</span>
            <p style={{color:"#888",fontSize:13,marginBottom:16,lineHeight:1.5}}>Enter a previous session to calibrate weight projections.</p>
            <div style={{marginBottom:16}}><span style={s.label}>Date</span><input style={s.input} type="date" value={pastDate} onChange={e=>setPastDate(e.target.value)} /></div>
            {pastRows.map((row,i)=>(
              <div key={i} style={{...s.card,padding:16,marginBottom:10}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
                  <span style={{...s.label,marginBottom:0}}>EXERCISE {i+1}</span>
                  {pastRows.length>1&&<button style={{background:"none",border:"none",color:"#ff6b6b",cursor:"pointer",fontSize:20}} onClick={()=>setPastRows(p=>p.filter((_,idx)=>idx!==i))}>√ó</button>}
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:8}}>
                  <select style={s.select} value={row.exId} onChange={e=>setPastRows(p=>p.map((r,idx)=>idx===i?{...r,exId:e.target.value}:r))}>
                    <option value="">Select exercise...</option>
                    {CATEGORIES.map(cat=>{const ces=allExercises.filter(e=>e.category===cat);if(!ces.length)return null;return(<optgroup key={cat} label={cat}>{ces.map(ex=><option key={ex.id} value={ex.id}>{ex.name}{ex.custom?" ‚òÖ":""}</option>)}</optgroup>);})}
                  </select>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
                    {[["WEIGHT","weight","135"],["REPS","reps","5"],["SETS","sets","3"]].map(([lbl,key,ph])=>(
                      <div key={key}><span style={{...s.label,fontSize:9}}>{lbl}</span><input style={{...s.input,padding:"10px 12px",fontSize:14}} type="number" placeholder={ph} value={row[key]} onChange={e=>setPastRows(p=>p.map((r,idx)=>idx===i?{...r,[key]:e.target.value}:r))} /></div>
                    ))}
                  </div>
                </div>
              </div>
            ))}
            <button style={{...s.btnOutline,width:"100%",marginBottom:10,fontSize:12}} onClick={()=>setPastRows(p=>[...p,{exId:"",weight:"",reps:"",sets:""}])}>+ ADD ANOTHER EXERCISE</button>
            <button style={s.btn} onClick={savePastWorkout}>SAVE PAST WORKOUT</button>
          </Modal>
        );
        return null;
      };

      // ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      // LOADING
      if (authUser===undefined||dataLoading) return (
        <div style={{...s.app,display:"flex",alignItems:"center",justifyContent:"center"}}>
          <div style={s.bg}/><div style={s.grid}/>
          <div style={{position:"relative",zIndex:1,textAlign:"center"}}>
            <div style={{color:"#e8ff6b",fontFamily:"'Space Mono',monospace",fontSize:22,letterSpacing:4,marginBottom:12}}>IRONFORM</div>
            <div style={{color:"#555",fontSize:12,letterSpacing:3}}>LOADING...</div>
          </div>
        </div>
      );

      // SIGN IN
      if (!authUser) return (
        <div style={{...s.app,display:"flex",alignItems:"center",justifyContent:"center"}}>
          <div style={s.bg}/><div style={s.grid}/>
          <div style={{position:"relative",zIndex:1,width:"100%",maxWidth:400,padding:"0 24px",textAlign:"center"}}>
            <div style={{fontFamily:"'Space Mono',monospace",fontSize:36,fontWeight:700,color:"#e8ff6b",letterSpacing:3,marginBottom:8}}>IRONFORM</div>
            <div style={{color:"#888",marginBottom:48,fontSize:15,lineHeight:1.6}}>Your personal trainer.<br/>Every device. Every gym.</div>
            <button onClick={handleSignIn} disabled={signingIn} style={{background:"#fff",color:"#0a0a0f",border:"none",borderRadius:14,padding:"16px 24px",fontFamily:"'Space Mono',monospace",fontWeight:700,fontSize:14,letterSpacing:1,cursor:"pointer",width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:12,opacity:signingIn?0.7:1}}>
              <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
              {signingIn?"Signing in...":"Continue with Google"}
            </button>
            {signInErr&&<div style={{marginTop:16,color:"#ff6b6b",fontSize:13}}>{signInErr}</div>}
          </div>
        </div>
      );

      // PRESET PREVIEW
      if (screen==="preset_preview"&&activeTmpl) {
        const tmpl=activeTmpl;
        const goal=profile?.goal||"hypertrophy";
        const allIds=[...tmpl.exercises,...extraExIds];
        return (
          <div style={s.app}>
            <div style={s.bg}/><div style={s.grid}/>{renderModal()}{Toast}
            <div style={s.content}>
              <div style={s.header}>
                <div style={s.logo}>IRONFORM</div>
                <span style={{...s.tag,background:tmpl.colorBg,border:`1px solid ${tmpl.colorBorder}`,color:tmpl.color}}>{tmpl.emoji} {tmpl.label.toUpperCase()}</span>
              </div>
              <BackBtn onClick={()=>{setActiveTmpl(null);setExtraExIds([]);setScreen("home");}} />

              <h2 style={{fontSize:24,fontWeight:800,marginBottom:16}}>{tmpl.label}</h2>

              {/* Sets & reps editor */}
              <div style={{...s.card,marginBottom:16}}>
                <span style={s.label}>SET & REP SCHEME</span>
                <div style={{display:"flex",justifyContent:"space-around",paddingTop:8}}>
                  <Stepper value={previewSets} onChange={setPreviewSets} min={1} label="SETS" />
                  <div style={{width:1,background:"rgba(255,255,255,0.06)"}}/>
                  <Stepper value={previewReps} onChange={setPreviewReps} min={1} label="REPS" />
                </div>
              </div>

              {/* Exercise list */}
              <span style={s.label}>EXERCISES ({allIds.length})</span>
              <div style={{marginBottom:8}}>
                {allIds.map(exId=>{
                  const def=allExercises.find(e=>e.id===exId);
                  if(!def) return null;
                  const last=getLastForExercise(exId);
                  const weight=last?safeProgressWeight(last.exercise.weight,goal,Math.max(1,Math.round((Date.now()-new Date(last.workout.date))/86400000/7)),def.unit):def.defaultWeight;
                  const isExtra=extraExIds.includes(exId);
                  return (
                    <div key={exId} style={{...s.card,marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center",padding:"14px 16px"}}>
                      <div>
                        <div style={{fontWeight:700,fontSize:15,display:"flex",alignItems:"center",gap:8}}>
                          {def.name}
                          {isExtra&&<span style={{fontSize:9,color:"#7ec8ff",fontFamily:"'Space Mono',monospace",background:"rgba(126,200,255,0.1)",border:"1px solid rgba(126,200,255,0.3)",borderRadius:4,padding:"2px 6px"}}>ADDED</span>}
                        </div>
                        <div style={{fontSize:12,color:"#555",marginTop:2,fontFamily:"'Space Mono',monospace"}}>
                          {def.unit==="reps"?"Bodyweight":`${weight} ${def.unit}`}
                          {last?` ¬∑ last ${new Date(last.workout.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})}`:" ¬∑ first time"}
                        </div>
                      </div>
                      {isExtra&&<button onClick={()=>setExtraExIds(p=>p.filter(id=>id!==exId))} style={{background:"none",border:"none",color:"#ff6b6b",cursor:"pointer",fontSize:20,padding:"0 4px",flexShrink:0}}>√ó</button>}
                    </div>
                  );
                })}
              </div>

              <button style={{...s.btnOutline,width:"100%",marginBottom:10,marginTop:4}} onClick={()=>setModal("browseAdd")}>
                + Add Exercise to Today's Workout
              </button>
              <button style={s.btn} onClick={()=>launchWorkout(tmpl,extraExIds,previewSets,previewReps)}>
                BEGIN {tmpl.label.toUpperCase()} ‚Üí
              </button>
            </div>
          </div>
        );
      }

      // CUSTOM BUILDER
      if (screen==="custom_builder") return (
        <div style={s.app}>
          <div style={s.bg}/><div style={s.grid}/>{renderModal()}{Toast}
          <div style={s.content}>
            <div style={s.header}><div style={s.logo}>IRONFORM</div><span style={s.tag}>CUSTOM</span></div>
            <BackBtn onClick={()=>{setCustomExIds([]);setCustomGoal("hypertrophy");setScreen("home");}} />

            <h2 style={{fontSize:24,fontWeight:800,marginBottom:6}}>Build Your Workout</h2>
            <p style={{color:"#888",fontSize:14,marginBottom:20,lineHeight:1.5}}>Pick your exercises, then go.</p>

            <div style={{...s.card,marginBottom:16}}>
              <span style={s.label}>Training Goal</span>
              <div style={{display:"flex",gap:8,flexWrap:"wrap",marginTop:4}}>
                {Object.entries(GOALS).map(([key,g])=>(
                  <button key={key} onClick={()=>setCustomGoal(key)} style={{background:customGoal===key?"rgba(232,255,107,0.15)":"rgba(255,255,255,0.04)",border:customGoal===key?"1px solid rgba(232,255,107,0.5)":"1px solid rgba(255,255,255,0.1)",borderRadius:8,padding:"8px 14px",color:customGoal===key?"#e8ff6b":"#888",fontSize:13,cursor:"pointer"}}>
                    {g.label}
                  </button>
                ))}
              </div>
            </div>

            {customExIds.length>0&&(
              <div style={s.card}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
                  <span style={s.label}>{customExIds.length} SELECTED</span>
                  <button style={{background:"none",border:"none",color:"#ff6b6b",cursor:"pointer",fontFamily:"'Space Mono',monospace",fontSize:10,letterSpacing:1}} onClick={()=>setCustomExIds([])}>CLEAR ALL</button>
                </div>
                {customExIds.map(exId=>{
                  const def=allExercises.find(e=>e.id===exId);
                  if(!def) return null;
                  return (
                    <div key={exId} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,0.05)"}}>
                      <span style={{fontSize:14}}>{def.name}</span>
                      <button onClick={()=>setCustomExIds(p=>p.filter(id=>id!==exId))} style={{background:"none",border:"none",color:"#ff6b6b",cursor:"pointer",fontSize:18,padding:"0 4px"}}>√ó</button>
                    </div>
                  );
                })}
              </div>
            )}

            <div style={s.card}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
                <span style={s.label}>BROWSE</span>
                <button style={s.btnSm} onClick={()=>{setActiveTmpl(null);setModal("browseAdd");}}>+ Add</button>
              </div>
              {CATEGORIES.map(cat=>{
                const ces=allExercises.filter(e=>e.category===cat&&!customExIds.includes(e.id));
                if(!ces.length) return null;
                return (
                  <div key={cat} style={{marginBottom:14}}>
                    <span style={{...s.label,fontSize:9}}>{cat}</span>
                    <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                      {ces.map(ex=>(
                        <button key={ex.id} onClick={()=>setCustomExIds(p=>[...p,ex.id])} style={{background:"rgba(255,255,255,0.04)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:8,padding:"7px 12px",color:"#888",fontSize:13,cursor:"pointer"}}>
                          {ex.name}{ex.custom?" ‚òÖ":""}
                        </button>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>

            <button style={{...s.btn,opacity:customExIds.length<1?0.4:1}} onClick={()=>customExIds.length>=1&&launchCustomWorkout()}>
              BEGIN WORKOUT ({customExIds.length} exercise{customExIds.length!==1?"s":""}) ‚Üí
            </button>
          </div>
        </div>
      );

      // ACTIVE WORKOUT ‚Äî one exercise at a time
      if (screen==="workout"&&activeWorkout) {
        const exercises = activeWorkout.exercises;
        const ex = exercises[currentExIdx];
        const done = setsForEx(ex);
        const allDone = done.every(Boolean);
        const lastRec = getLastForExercise(ex.id);
        const isLast = currentExIdx===exercises.length-1;
        const progress = totalSets>0?totalDone/totalSets:0;

        return (
          <div style={s.app}>
            <div style={s.bg}/><div style={s.grid}/>{Toast}
            <div style={s.content}>

              {/* Top bar */}
              <div style={s.header}>
                <div style={s.logo}>IRONFORM</div>
                <button style={s.btnDanger} onClick={cancelWorkout}>CANCEL</button>
              </div>

              {/* Overall progress */}
              <div style={{marginBottom:20}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                  <span style={{...s.label,marginBottom:0}}>{activeWorkout.templateLabel} ¬∑ Exercise {currentExIdx+1} of {exercises.length}</span>
                  <span style={{fontFamily:"'Space Mono',monospace",fontSize:12,color:"#e8ff6b"}}>{totalDone}/{totalSets} sets</span>
                </div>
                <div style={{height:4,background:"rgba(255,255,255,0.06)",borderRadius:2,overflow:"hidden"}}>
                  <div style={{height:"100%",width:`${progress*100}%`,background:"#e8ff6b",borderRadius:2,transition:"width 0.4s ease"}}/>
                </div>

                {/* Exercise dots navigation */}
                <div style={{display:"flex",gap:6,marginTop:12,flexWrap:"wrap"}}>
                  {exercises.map((e,i)=>{
                    const exDone=setsForEx(e).every(Boolean);
                    const isCurrent=i===currentExIdx;
                    return (
                      <button key={i} onClick={()=>setCurrentExIdx(i)} style={{width:28,height:6,borderRadius:3,border:"none",cursor:"pointer",background:isCurrent?"#e8ff6b":exDone?"rgba(232,255,107,0.4)":"rgba(255,255,255,0.1)",transition:"all 0.2s",padding:0,flexShrink:0}}/>
                    );
                  })}
                </div>
              </div>

              {/* Current exercise card */}
              <div style={{...s.card,padding:24}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                  <div>
                    <div style={{fontWeight:900,fontSize:24,lineHeight:1.2}}>{ex.name}</div>
                    <div style={{color:"#888",fontSize:14,marginTop:4}}>{ex.sets} sets √ó {ex.reps} reps</div>
                  </div>
                  {allDone&&<div style={{color:"#e8ff6b",fontSize:28}}>‚úì</div>}
                </div>

                {lastRec&&(
                  <div style={{fontSize:12,color:"#556",marginBottom:16,fontFamily:"'Space Mono',monospace",background:"rgba(255,255,255,0.03)",borderRadius:8,padding:"8px 12px"}}>
                    LAST SESSION: {lastRec.exercise.weight}{lastRec.exercise.unit!=="reps"?lastRec.exercise.unit:""} ¬∑ {new Date(lastRec.workout.date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}
                  </div>
                )}

                {/* Weight adjuster */}
                <div style={{display:"flex",alignItems:"center",gap:16,marginBottom:24,justifyContent:"center"}}>
                  <button style={s.setBtn} onClick={()=>adjustWeight(ex.id,-ex.increment)}>‚àí</button>
                  <div style={{textAlign:"center",minWidth:100}}>
                    <div style={{fontSize:48,fontWeight:900,color:"#e8ff6b",lineHeight:1}}>{ex.weight}</div>
                    <div style={{fontSize:11,color:"#555",letterSpacing:2,fontFamily:"'Space Mono',monospace",marginTop:2}}>{ex.unit==="reps"?"BODYWEIGHT":ex.unit.toUpperCase()}</div>
                  </div>
                  <button style={s.setBtn} onClick={()=>adjustWeight(ex.id,ex.increment)}>+</button>
                </div>

                {/* Set dots */}
                <span style={s.label}>TAP TO COMPLETE SETS</span>
                <div style={{display:"flex",gap:10,flexWrap:"wrap",marginBottom:16}}>
                  {done.map((d,i)=>(
                    <button key={i} style={s.setDot(d)} onClick={()=>toggleSet(ex.id,i)}>
                      {d?"‚úì":i+1}
                    </button>
                  ))}
                </div>

                {/* Notes */}
                <input style={{...s.input,fontSize:13,padding:"10px 14px"}} placeholder="Notes (optional)..." value={noteFor[ex.id]||""} onChange={e=>setNoteFor(p=>({...p,[ex.id]:e.target.value}))} />
              </div>

              {/* Navigation */}
              <div style={{display:"grid",gridTemplateColumns:currentExIdx>0?"1fr 1fr":"1fr",gap:10,marginTop:4}}>
                {currentExIdx>0&&(
                  <button style={{...s.btnOutline,width:"100%",textAlign:"center"}} onClick={()=>setCurrentExIdx(i=>i-1)}>
                    ‚Üê PREV
                  </button>
                )}
                {!isLast?(
                  <button style={s.btn} onClick={()=>setCurrentExIdx(i=>i+1)}>
                    NEXT EXERCISE ‚Üí
                  </button>
                ):(
                  <button style={{...s.btn,background:progress>=0.3?"#e8ff6b":"rgba(232,255,107,0.3)",color:progress>=0.3?"#0a0a0f":"#666",marginTop:0}} onClick={progress>=0.3?finishWorkout:undefined}>
                    {progress>=1?"FINISH WORKOUT ‚úì":`FINISH EARLY (${totalDone}/${totalSets} sets)`}
                  </button>
                )}
              </div>

            </div>
          </div>
        );
      }

      // HISTORY
      if (screen==="history") return (
        <div style={s.app}>
          <div style={s.bg}/><div style={s.grid}/>{renderModal()}{Toast}
          <div style={s.content}>
            <div style={s.header}>
              <div style={s.logo}>IRONFORM</div>
              <button style={s.btnSm} onClick={()=>{setPastDate("");setPastRows([{exId:"",weight:"",reps:"",sets:""}]);setModal("logPastWorkout");}}>+ LOG PAST</button>
            </div>
            {workouts.length===0?(
              <div style={{...s.card,textAlign:"center",padding:48}}>
                <div style={{fontSize:40,marginBottom:12}}>üìã</div>
                <div style={{color:"#888",marginBottom:20}}>No workouts logged yet.</div>
                <button style={s.btnOutline} onClick={()=>{setPastDate("");setPastRows([{exId:"",weight:"",reps:"",sets:""}]);setModal("logPastWorkout");}}>Import Past Workouts</button>
              </div>
            ):[...workouts].reverse().map(w=>(
              <div key={w._id||w.date} style={s.card}>
                <div style={{display:"flex",justifyContent:"space-between",marginBottom:12}}>
                  <div>
                    <div style={{fontWeight:800,fontSize:16}}>{new Date(w.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"})}</div>
                    <div style={{color:"#888",fontSize:13}}>{w.exercises?.length} exercises</div>
                  </div>
                  <div style={{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap",justifyContent:"flex-end"}}>
                    {w.templateLabel&&(()=>{const t=WORKOUT_TEMPLATES.find(x=>x.label===w.templateLabel);return <span style={{...s.tag,background:t?t.colorBg:"rgba(255,255,255,0.05)",border:`1px solid ${t?t.colorBorder:"rgba(255,255,255,0.1)"}`,color:t?t.color:"#aaa"}}>{w.templateLabel.toUpperCase()}</span>;})()}
                    {w.imported&&<span style={{...s.tag,background:"rgba(100,180,255,0.1)",border:"1px solid rgba(100,180,255,0.3)",color:"#7ec8ff"}}>IMPORTED</span>}
                    <span style={s.tag}>{w.completed?"DONE":"PARTIAL"}</span>
                  </div>
                </div>
                {w.exercises?.map(ex=>(
                  <div key={ex.id} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:"1px solid rgba(255,255,255,0.04)",fontSize:14}}>
                    <span style={{color:"#ccc"}}>{ex.name}</span>
                    <span style={{color:"#e8ff6b",fontFamily:"'Space Mono',monospace",fontSize:13}}>{ex.unit==="reps"?`BW √ó ${ex.reps}`:`${ex.weight}${ex.unit} √ó ${ex.reps}`}{ex.sets>1?` √ó ${ex.sets}s`:""}</span>
                  </div>
                ))}
              </div>
            ))}
          </div>
          <NavBar active="history"/>
        </div>
      );

      // PROFILE
      if (screen==="profile") return (
        <div style={s.app}>
          <div style={s.bg}/><div style={s.grid}/>{renderModal()}{Toast}
          <div style={s.content}>
            <div style={s.header}><div style={s.logo}>IRONFORM</div><span style={s.tag}>PROFILE</span></div>
            <div style={s.accentCard}>
              <div style={{display:"flex",alignItems:"center",gap:14,marginBottom:8}}>
                {authUser.photoURL&&<img src={authUser.photoURL} alt="" style={{width:52,height:52,borderRadius:"50%",border:"2px solid rgba(232,255,107,0.4)"}}/>}
                <div>
                  <div style={{fontSize:22,fontWeight:900}}>{authUser.displayName||"Athlete"}</div>
                  <div style={{color:"#888",fontSize:13}}>{authUser.email}</div>
                </div>
              </div>
              <div style={{color:"#888",marginTop:4}}>Goal: <span style={{color:"#e8ff6b"}}>{GOALS[profile?.goal]?.label}</span> ¬∑ {workouts.length} workouts logged</div>
            </div>
            <div style={s.card}>
              <span style={s.label}>Default Training Goal</span>
              <div style={{display:"flex",flexDirection:"column",gap:8,marginTop:8}}>
                {Object.entries(GOALS).map(([key,g])=>(
                  <button key={key} onClick={async()=>{await saveProfile({...profile,goal:key});showToast("Goal updated!");}}
                    style={{background:profile?.goal===key?"rgba(232,255,107,0.12)":"rgba(255,255,255,0.03)",border:profile?.goal===key?"1px solid rgba(232,255,107,0.4)":"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:"12px 16px",cursor:"pointer",color:profile?.goal===key?"#e8ff6b":"#888",textAlign:"left",fontFamily:"'DM Sans',sans-serif",fontSize:14,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                    <div><div style={{fontWeight:600}}>{g.label}</div><div style={{fontSize:12,opacity:0.7}}>{g.description}</div></div>
                    {profile?.goal===key&&<span>‚úì</span>}
                  </button>
                ))}
              </div>
            </div>
            <div style={s.card}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
                <span style={s.label}>Custom Exercises ({customExs.length})</span>
                <button style={s.btnSm} onClick={()=>{setNewEx({name:"",category:"Chest",unit:"lbs",defaultWeight:45,increment:5});setModal("addExercise");}}>+ NEW</button>
              </div>
              {customExs.length===0?<p style={{color:"#555",fontSize:13}}>None yet.</p>:customExs.map(ex=>(
                <div key={ex._fid||ex.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,0.04)"}}>
                  <div><span style={{fontSize:14}}>{ex.name}</span><div style={{fontSize:11,color:"#555"}}>{ex.category} ¬∑ {ex.unit==="reps"?"bodyweight":`${ex.defaultWeight}${ex.unit}`}</div></div>
                </div>
              ))}
            </div>
            <button style={{...s.btnDanger,width:"100%",marginTop:8}} onClick={handleSignOut}>Sign Out</button>
          </div>
          <NavBar active="profile"/>
        </div>
      );

      // HOME
      const tiles = [
        ...WORKOUT_TEMPLATES.map(tmpl=>{
          const last=[...workouts].reverse().find(w=>w.templateLabel===tmpl.label);
          const days=last?Math.floor((Date.now()-new Date(last.date))/86400000):null;
          return {id:tmpl.id,emoji:tmpl.emoji,label:tmpl.label,sub:days!==null?(days===0?"Today":`${days}d ago`):"Never done",color:tmpl.color,colorBg:tmpl.colorBg,colorBorder:tmpl.colorBorder,
            onClick:()=>{
              setActiveTmpl(tmpl);setExtraExIds([]);
              const sr=GOAL_SETS[profile?.goal||"hypertrophy"];
              setPreviewSets(sr.sets);setPreviewReps(sr.reps);
              setScreen("preset_preview");
            }};
        }),
        {id:"custom",emoji:"‚ö°",label:"Custom",sub:"Build your own",color:"#c084fc",colorBg:"rgba(192,132,252,0.08)",colorBorder:"rgba(192,132,252,0.35)",
          onClick:()=>{setCustomExIds([]);setCustomGoal("hypertrophy");setScreen("custom_builder");}},
      ];

      const lastWorkout=workouts[workouts.length-1];
      const daysSinceLast=lastWorkout?Math.floor((Date.now()-new Date(lastWorkout.date))/86400000):null;
      const streak=(()=>{if(!workouts.length)return 0;let s=0;const d=new Date();d.setHours(0,0,0,0);const dates=new Set(workouts.map(w=>new Date(w.date).toDateString()));const cur=new Date(d);while(dates.has(cur.toDateString())){s++;cur.setDate(cur.getDate()-1);}return s;})();

      return (
        <div style={s.app}>
          <div style={s.bg}/><div style={s.grid}/>
          {/* Modals always rendered on home screen too ‚Äî this was the bug fix */}
          {renderModal()}
          {Toast}
          <div style={s.content}>
            <div style={s.header}>
              <div style={s.logo}>IRONFORM</div>
              {authUser.photoURL&&<img src={authUser.photoURL} alt="" style={{width:30,height:30,borderRadius:"50%",border:"1px solid rgba(232,255,107,0.3)",cursor:"pointer"}} onClick={()=>setScreen("profile")}/>}
            </div>

            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10,marginBottom:24}}>
              {[{label:"WORKOUTS",value:workouts.length},{label:"DAYS REST",value:daysSinceLast===null?"‚Äî":daysSinceLast},{label:"STREAK",value:streak}].map(stat=>(
                <div key={stat.label} style={{...s.card,padding:16,textAlign:"center",marginBottom:0}}>
                  <div style={{fontSize:26,fontWeight:900,color:"#e8ff6b",lineHeight:1}}>{stat.value}</div>
                  <span style={{...s.label,marginBottom:0,marginTop:4}}>{stat.label}</span>
                </div>
              ))}
            </div>

            <span style={s.label}>START A WORKOUT</span>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:20}}>
              {tiles.map(tile=>(
                <button key={tile.id} onClick={tile.onClick} style={{background:tile.colorBg,border:`1px solid ${tile.colorBorder}`,borderRadius:18,padding:"24px 16px",cursor:"pointer",textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center",gap:8,width:"100%"}}>
                  <span style={{fontSize:34}}>{tile.emoji}</span>
                  <span style={{fontFamily:"'Space Mono',monospace",fontWeight:700,fontSize:13,color:tile.color,letterSpacing:1,lineHeight:1.3}}>{tile.label.toUpperCase()}</span>
                  <span style={{fontSize:11,color:"#555",fontFamily:"'Space Mono',monospace"}}>{tile.sub}</span>
                </button>
              ))}
            </div>

            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:16}}>
              <button style={{...s.card,marginBottom:0,cursor:"pointer",textAlign:"center",padding:14,border:"1px solid rgba(100,180,255,0.2)",background:"rgba(100,180,255,0.05)"}}
                onClick={()=>{setPastDate("");setPastRows([{exId:"",weight:"",reps:"",sets:""}]);setModal("logPastWorkout");}}>
                <div style={{fontSize:20,marginBottom:4}}>üì•</div>
                <div style={{fontSize:11,fontFamily:"'Space Mono',monospace",color:"#7ec8ff",letterSpacing:1}}>LOG PAST</div>
              </button>
              <button style={{...s.card,marginBottom:0,cursor:"pointer",textAlign:"center",padding:14,border:"1px solid rgba(192,132,252,0.2)",background:"rgba(192,132,252,0.05)"}}
                onClick={()=>{setNewEx({name:"",category:"Chest",unit:"lbs",defaultWeight:45,increment:5});setModal("addExercise");}}>
                <div style={{fontSize:20,marginBottom:4}}>‚ûï</div>
                <div style={{fontSize:11,fontFamily:"'Space Mono',monospace",color:"#c084fc",letterSpacing:1}}>NEW LIFT</div>
              </button>
            </div>

            {lastWorkout&&(
              <div style={s.card}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
                  <span style={s.label}>LAST SESSION</span>
                  <span style={{fontSize:12,color:"#555"}}>{new Date(lastWorkout.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})}</span>
                </div>
                {lastWorkout.exercises?.slice(0,4).map(ex=>(
                  <div key={ex.id} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:"1px solid rgba(255,255,255,0.04)",fontSize:14}}>
                    <span style={{color:"#aaa"}}>{ex.name}</span>
                    <span style={{color:"#e8ff6b",fontFamily:"'Space Mono',monospace",fontSize:13}}>{ex.unit==="reps"?`BW √ó ${ex.reps}`:`${ex.weight}${ex.unit} √ó ${ex.reps}`}</span>
                  </div>
                ))}
              </div>
            )}
          </div>
          <NavBar active="home"/>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
